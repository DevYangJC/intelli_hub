# 网关管理功能设计方案

## 一、概述

### 1.1 背景

当前系统中,网关路由配置通过 `api_info` 和 `api_backend` 表管理,但缺少可视化的管理界面。运维人员需要通过数据库或后端API直接操作,效率低且容易出错。

### 1.2 目标

- 提供可视化的网关路由管理界面
- 支持路由的CRUD操作
- 支持限流策略配置
- 实现配置的热更新机制
- 提升运维效率,降低配置错误率

### 1.3 架构原则

**职责分离**:
- ✅ **API Platform Service**: 负责路由配置的CRUD操作
- ✅ **Gateway Service**: 负责读取配置并执行路由转发
- ✅ **配置同步**: 通过Redis Pub/Sub或事件机制实现热更新

---

## 二、现有架构分析

### 2.1 数据模型

#### api_info 表 (API基础信息)
```sql
- id: API唯一标识
- path: 请求路径 (如 /api/v1/user/login)
- method: 请求方法 (GET/POST/PUT/DELETE)
- auth_type: 认证方式 (none/token/signature)
- timeout: 超时时间
- rate_limit_enabled: 是否启用限流
- rate_limit_qps: 限流QPS
- mock_enabled: 是否启用Mock
- mock_response: Mock响应数据
- status: API状态 (draft/published/offline/deprecated)
```

#### api_backend 表 (后端配置)
```sql
- api_id: 关联的API ID
- type: 后端类型 (http/mock/dubbo)
- protocol: 协议 (HTTP/HTTPS)
- method: 后端请求方法
- host: 后端地址
- path: 后端路径
- timeout: 超时时间
- dubbo_interface: Dubbo接口名
- dubbo_method: Dubbo方法名
- dubbo_version: Dubbo版本
- dubbo_group: Dubbo分组
```

### 2.2 现有功能

✅ **已实现**:
- Dubbo接口: `ApiPlatformDubboService` 提供路由查询
  - `getRouteByPath()`: 根据路径查询路由
  - `getAllPublishedRoutes()`: 获取所有已发布路由
  - `matchRouteByPath()`: 路径匹配
- 路由变更通知: `ApiRouteEventPublisher` 通过Redis Pub/Sub通知网关
- 网关动态加载: `OpenApiRouteFilter` 动态匹配路由

❌ **缺失**:
- 可视化路由管理界面
- 路由配置的HTTP API
- 限流策略独立管理
- 插件配置管理

---

## 三、功能设计

### 3.1 网关路由管理

#### 3.1.1 功能列表

| 功能 | 说明 | 优先级 |
|------|------|--------|
| 路由列表查询 | 分页查询、搜索、筛选 | P0 |
| 路由详情查看 | 查看路由完整配置 | P0 |
| 路由创建 | 创建新路由配置 | P0 |
| 路由编辑 | 修改路由配置 | P0 |
| 路由删除 | 删除路由(软删除) | P0 |
| 路由启用/禁用 | 快速切换路由状态 | P1 |
| 路由测试 | 测试路由是否可用 | P1 |
| 批量操作 | 批量启用/禁用/删除 | P2 |

#### 3.1.2 API接口设计

**基础路径**: `/api/v1/gateway/routes`

##### 1. 查询路由列表
```http
GET /api/v1/gateway/routes?page=1&size=20&keyword=user&status=published&backendType=http

Response:
{
  "code": 200,
  "message": "success",
  "data": {
    "total": 100,
    "records": [
      {
        "id": "API001",
        "name": "用户登录",
        "path": "/api/v1/user/login",
        "method": "POST",
        "status": "published",
        "authType": "none",
        "backendType": "http",
        "backendHost": "http://user-service:8080",
        "backendPath": "/internal/user/login",
        "timeout": 5000,
        "rateLimitEnabled": true,
        "rateLimitQps": 100,
        "createdAt": "2024-12-01 10:00:00",
        "updatedAt": "2024-12-26 15:30:00"
      }
    ]
  }
}
```

##### 2. 查询路由详情
```http
GET /api/v1/gateway/routes/{id}

Response:
{
  "code": 200,
  "message": "success",
  "data": {
    "id": "API001",
    "tenantId": "1",
    "groupId": "G001",
    "name": "用户登录",
    "code": "user-login",
    "version": "v1",
    "description": "用户账号密码登录接口",
    "method": "POST",
    "path": "/api/v1/user/login",
    "protocol": "HTTPS",
    "contentType": "application/json",
    "status": "published",
    "authType": "none",
    "timeout": 5000,
    "retryCount": 0,
    "cacheEnabled": false,
    "cacheTtl": 0,
    "rateLimitEnabled": true,
    "rateLimitQps": 100,
    "mockEnabled": false,
    "mockResponse": null,
    "ipWhitelistEnabled": false,
    "ipWhitelist": null,
    "backend": {
      "type": "http",
      "protocol": "HTTP",
      "method": "POST",
      "host": "http://user-service:8080",
      "path": "/internal/user/login",
      "timeout": 5000,
      "connectTimeout": 1000
    },
    "createdAt": "2024-12-01 10:00:00",
    "updatedAt": "2024-12-26 15:30:00"
  }
}
```

##### 3. 创建路由
```http
POST /api/v1/gateway/routes

Request:
{
  "groupId": "G001",
  "name": "用户登录",
  "code": "user-login",
  "version": "v1",
  "description": "用户账号密码登录接口",
  "method": "POST",
  "path": "/api/v1/user/login",
  "protocol": "HTTPS",
  "contentType": "application/json",
  "authType": "none",
  "timeout": 5000,
  "retryCount": 0,
  "cacheEnabled": false,
  "cacheTtl": 0,
  "rateLimitEnabled": true,
  "rateLimitQps": 100,
  "mockEnabled": false,
  "backend": {
    "type": "http",
    "protocol": "HTTP",
    "method": "POST",
    "host": "http://user-service:8080",
    "path": "/internal/user/login",
    "timeout": 5000,
    "connectTimeout": 1000
  }
}

Response:
{
  "code": 200,
  "message": "路由创建成功",
  "data": {
    "id": "API014"
  }
}
```

##### 4. 更新路由
```http
PUT /api/v1/gateway/routes/{id}

Request: (同创建路由)

Response:
{
  "code": 200,
  "message": "路由更新成功",
  "data": null
}
```

##### 5. 删除路由
```http
DELETE /api/v1/gateway/routes/{id}

Response:
{
  "code": 200,
  "message": "路由删除成功",
  "data": null
}
```

##### 6. 启用/禁用路由
```http
POST /api/v1/gateway/routes/{id}/publish   # 发布(启用)
POST /api/v1/gateway/routes/{id}/offline   # 下线(禁用)

Response:
{
  "code": 200,
  "message": "操作成功",
  "data": null
}
```

##### 7. 批量操作
```http
POST /api/v1/gateway/routes/batch

Request:
{
  "action": "publish",  // publish/offline/delete
  "ids": ["API001", "API002", "API003"]
}

Response:
{
  "code": 200,
  "message": "批量操作成功",
  "data": {
    "success": 3,
    "failed": 0
  }
}
```

##### 8. 路由测试
```http
POST /api/v1/gateway/routes/{id}/test

Request:
{
  "headers": {
    "Content-Type": "application/json"
  },
  "body": {
    "username": "admin",
    "password": "123456"
  }
}

Response:
{
  "code": 200,
  "message": "测试成功",
  "data": {
    "statusCode": 200,
    "responseTime": 125,
    "responseBody": "{...}"
  }
}
```

---

### 3.2 限流策略管理

#### 3.2.1 数据模型设计

**新增表**: `gateway_ratelimit_policy`

```sql
CREATE TABLE gateway_ratelimit_policy (
  id VARCHAR(32) PRIMARY KEY COMMENT '主键ID',
  tenant_id VARCHAR(32) NOT NULL COMMENT '租户ID',
  name VARCHAR(100) NOT NULL COMMENT '策略名称',
  description VARCHAR(500) COMMENT '策略描述',
  type VARCHAR(20) NOT NULL COMMENT '限流类型: qps/concurrency',
  dimension VARCHAR(20) NOT NULL COMMENT '限流维度: global/ip/path/ip_path/user',
  limit_value INT NOT NULL COMMENT '限流阈值',
  time_window INT NOT NULL DEFAULT 1 COMMENT '时间窗口(秒)',
  status VARCHAR(20) NOT NULL DEFAULT 'active' COMMENT '状态: active/inactive',
  created_by VARCHAR(32) COMMENT '创建人',
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  deleted_at DATETIME COMMENT '删除时间',
  INDEX idx_tenant_id (tenant_id),
  INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='网关限流策略表';
```

**关联表**: `gateway_route_ratelimit` (路由与限流策略关联)

```sql
CREATE TABLE gateway_route_ratelimit (
  id VARCHAR(32) PRIMARY KEY COMMENT '主键ID',
  route_id VARCHAR(32) NOT NULL COMMENT '路由ID(api_id)',
  policy_id VARCHAR(32) NOT NULL COMMENT '策略ID',
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  UNIQUE KEY uk_route_policy (route_id, policy_id),
  INDEX idx_route_id (route_id),
  INDEX idx_policy_id (policy_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='路由限流策略关联表';
```

#### 3.2.2 API接口设计

**基础路径**: `/api/v1/gateway/ratelimit`

##### 1. 查询限流策略列表
```http
GET /api/v1/gateway/ratelimit/policies?page=1&size=20&keyword=&status=active

Response:
{
  "code": 200,
  "message": "success",
  "data": {
    "total": 10,
    "records": [
      {
        "id": "RL001",
        "name": "默认限流策略",
        "description": "全局默认限流",
        "type": "qps",
        "dimension": "global",
        "limitValue": 1000,
        "timeWindow": 1,
        "status": "active",
        "appliedRoutes": 15,
        "createdAt": "2024-12-01 10:00:00"
      }
    ]
  }
}
```

##### 2. 创建限流策略
```http
POST /api/v1/gateway/ratelimit/policies

Request:
{
  "name": "高频API限流",
  "description": "针对高频调用API的限流策略",
  "type": "qps",
  "dimension": "ip_path",
  "limitValue": 100,
  "timeWindow": 1
}

Response:
{
  "code": 200,
  "message": "策略创建成功",
  "data": {
    "id": "RL002"
  }
}
```

##### 3. 应用限流策略到路由
```http
POST /api/v1/gateway/ratelimit/policies/{policyId}/apply

Request:
{
  "routeIds": ["API001", "API002", "API003"]
}

Response:
{
  "code": 200,
  "message": "策略应用成功",
  "data": {
    "applied": 3
  }
}
```

##### 4. 移除路由的限流策略
```http
DELETE /api/v1/gateway/ratelimit/policies/{policyId}/routes/{routeId}

Response:
{
  "code": 200,
  "message": "策略移除成功",
  "data": null
}
```

---

## 四、配置同步机制

### 4.1 现有机制

当前系统已实现 `ApiRouteEventPublisher`,通过Redis Pub/Sub通知网关:

```java
// 发布路由变更事件
redisTemplate.convertAndSend("api:route:change", apiId);
```

网关监听器 `ApiRouteChangeListener` 接收通知并刷新缓存。

### 4.2 优化方案

**保持现有机制**,在路由CRUD操作后自动触发:

```java
// 创建/更新/删除路由后
apiRouteEventPublisher.publishRouteChange(apiId);

// 批量操作后
apiRouteEventPublisher.publishRouteRefresh(); // 刷新所有路由
```

---

## 五、前端设计

### 5.1 页面结构

```
GatewayManagePage.vue (网关管理主页)
├── RouteManagementTab.vue (路由管理Tab)
│   ├── RouteListTable.vue (路由列表表格)
│   ├── RouteSearchForm.vue (搜索表单)
│   ├── RouteEditDialog.vue (路由编辑对话框)
│   └── RouteTestDialog.vue (路由测试对话框)
└── RatelimitManagementTab.vue (限流管理Tab)
    ├── PolicyListTable.vue (策略列表表格)
    ├── PolicyEditDialog.vue (策略编辑对话框)
    └── PolicyApplyDialog.vue (策略应用对话框)
```

### 5.2 核心组件

#### RouteEditDialog.vue (路由编辑对话框)

**表单字段**:
- 基础信息: 名称、编码、版本、描述、分组
- 请求配置: 方法、路径、协议、内容类型
- 认证配置: 认证方式(none/token/signature)
- 超时配置: 超时时间、重试次数
- 缓存配置: 是否启用、缓存时间
- 限流配置: 是否启用、QPS限制
- Mock配置: 是否启用、Mock响应
- 后端配置:
  - HTTP: 协议、方法、地址、路径
  - Dubbo: 接口名、方法名、版本、分组
  - Mock: 延迟时间

**验证规则**:
- 路径格式验证(必须以/开头)
- 路径唯一性验证(同租户下path+method唯一)
- 后端地址格式验证
- QPS数值范围验证

---

## 六、实施计划

### 阶段一: 后端API开发 (3-4天)

#### Day 1: DTO和实体创建
- [x] 创建 `GatewayRouteDTO` (路由管理专用DTO)
- [x] 创建 `RatelimitPolicyDTO`
- [x] 创建 `RatelimitPolicy` 实体
- [x] 创建 `RouteRatelimit` 关联实体

#### Day 2: 路由管理服务
- [ ] 创建 `GatewayRouteController`
- [ ] 实现路由CRUD接口
- [ ] 实现路由发布/下线接口
- [ ] 集成 `ApiRouteEventPublisher` 触发通知

#### Day 3: 限流策略服务
- [ ] 创建数据库表
- [ ] 创建 `RatelimitPolicyService`
- [ ] 创建 `RatelimitPolicyController`
- [ ] 实现策略CRUD接口
- [ ] 实现策略应用接口

#### Day 4: 测试与优化
- [ ] 单元测试
- [ ] 接口联调测试
- [ ] 性能优化

### 阶段二: 前端开发 (4-5天)

#### Day 1-2: 路由管理页面
- [ ] 创建路由管理页面框架
- [ ] 实现路由列表表格
- [ ] 实现搜索和筛选功能
- [ ] 实现路由编辑对话框

#### Day 3-4: 限流管理页面
- [ ] 创建限流管理Tab
- [ ] 实现策略列表
- [ ] 实现策略编辑对话框
- [ ] 实现策略应用功能

#### Day 5: 测试与优化
- [ ] 功能测试
- [ ] UI优化
- [ ] 用户体验优化

### 阶段三: 集成测试与文档 (1-2天)

- [ ] 端到端测试
- [ ] 编写用户手册
- [ ] 编写API文档
- [ ] 演示视频录制

---

## 七、技术要点

### 7.1 路径唯一性校验

```java
// 创建/更新时校验
public void validateRouteUniqueness(String path, String method, String excludeId) {
    LambdaQueryWrapper<ApiInfo> wrapper = new LambdaQueryWrapper<>();
    wrapper.eq(ApiInfo::getPath, path)
           .eq(ApiInfo::getMethod, method)
           .ne(excludeId != null, ApiInfo::getId, excludeId)
           .isNull(ApiInfo::getDeletedAt);
    
    long count = apiInfoMapper.selectCount(wrapper);
    if (count > 0) {
        throw new BusinessException("路由已存在: " + method + " " + path);
    }
}
```

### 7.2 配置热更新

```java
// 路由变更后触发
@Transactional
public void updateRoute(String id, GatewayRouteDTO dto) {
    // 1. 更新数据库
    updateApiInfo(id, dto);
    updateApiBackend(id, dto.getBackend());
    
    // 2. 发布变更事件
    apiRouteEventPublisher.publishRouteChange(id);
    
    // 3. 记录操作日志
    auditLog("UPDATE_ROUTE", id);
}
```

### 7.3 限流策略应用

```java
// 应用策略到路由
@Transactional
public void applyPolicyToRoutes(String policyId, List<String> routeIds) {
    // 1. 删除旧关联
    routeRatelimitMapper.deleteByPolicyId(policyId);
    
    // 2. 创建新关联
    for (String routeId : routeIds) {
        RouteRatelimit relation = new RouteRatelimit();
        relation.setId(IdUtil.simpleUUID());
        relation.setRouteId(routeId);
        relation.setPolicyId(policyId);
        routeRatelimitMapper.insert(relation);
    }
    
    // 3. 通知网关刷新
    apiRouteEventPublisher.publishRouteRefresh();
}
```

---

## 八、风险与注意事项

### 8.1 数据一致性

**风险**: 路由配置更新后,网关可能未及时刷新

**解决方案**:
- 使用Redis Pub/Sub保证通知送达
- 网关定时全量刷新(兜底机制)
- 提供手动刷新按钮

### 8.2 并发更新

**风险**: 多人同时编辑同一路由

**解决方案**:
- 乐观锁(version字段)
- 更新时间戳校验
- 前端提示冲突

### 8.3 路径冲突

**风险**: 新建路由与现有路由路径冲突

**解决方案**:
- 创建前校验唯一性
- 支持路径模糊匹配查询
- 提供路径冲突检测工具

---

## 九、后续优化

### P2 功能

1. **插件配置管理**
   - 插件列表查看
   - 插件参数配置
   - 插件执行顺序调整

2. **路由版本管理**
   - 路由配置快照
   - 版本对比
   - 版本回滚

3. **灰度发布**
   - 按百分比分流
   - 按用户标签分流
   - A/B测试支持

4. **配置导入导出**
   - JSON格式导出
   - 批量导入
   - 配置模板

---

*文档版本: v1.0*  
*创建时间: 2025-01-04*  
*作者: IntelliHub Team*
