# èšåˆæœç´¢æœåŠ¡ - é—®é¢˜åˆ†ææŠ¥å‘Š

## ğŸ“‹ æ£€æŸ¥æ¦‚è§ˆ

**æ£€æŸ¥æ—¶é—´**: 2025-01-04  
**æœåŠ¡åç§°**: intelli-search-service  
**æœåŠ¡ç«¯å£**: 8086  
**æ£€æŸ¥èŒƒå›´**: é…ç½®ã€ä»£ç å®ç°ã€ä¾èµ–ã€æ½œåœ¨é—®é¢˜

---

## âœ… æœåŠ¡åŸºæœ¬ä¿¡æ¯

### æœåŠ¡é…ç½®
- **æœåŠ¡å**: intelli-search-service
- **ç«¯å£**: 8086
- **Nacosåœ°å€**: 127.0.0.1:8848
- **Elasticsearch**: 192.168.200.130:9200
- **MySQL**: 192.168.200.130:3306/intelli_hub_search
- **Redis**: 192.168.200.130:6379 (database: 2)

### æ ¸å¿ƒåŠŸèƒ½
1. **èšåˆæœç´¢**: è·¨å¤šä¸ªç´¢å¼•çš„ç»Ÿä¸€æœç´¢
2. **APIç´¢å¼•**: APIæ–‡æ¡£çš„ç´¢å¼•å’Œæœç´¢
3. **åº”ç”¨ç´¢å¼•**: åº”ç”¨ä¿¡æ¯çš„ç´¢å¼•å’Œæœç´¢
4. **ç”¨æˆ·ç´¢å¼•**: ç”¨æˆ·ä¿¡æ¯çš„ç´¢å¼•å’Œæœç´¢
5. **å®šæ—¶åŒæ­¥**: å®šæ—¶å…¨é‡å’Œå¢é‡åŒæ­¥æ•°æ®

---

## âœ… ä»£ç æ£€æŸ¥ç»“æœ

### 1. ä¸»ç±»é…ç½® âœ…
**æ–‡ä»¶**: `IntelliSearchServiceApplication.java`

```java
@SpringBootApplication(scanBasePackages = {"com.intellihub"})
@EnableDiscoveryClient
@EnableTransactionManagement
@EnableScheduling
@EnableDubbo
```

**æ£€æŸ¥ç»“æœ**: âœ… æ­£ç¡®
- ä½¿ç”¨äº†æ­£ç¡®çš„åŒ…æ‰«æè·¯å¾„
- å¯ç”¨äº†æ‰€æœ‰å¿…è¦çš„åŠŸèƒ½

---

### 2. ä¾èµ–é…ç½® âœ…
**æ–‡ä»¶**: `pom.xml`

**æ ¸å¿ƒä¾èµ–**:
- âœ… Spring Boot Web
- âœ… Spring Boot Validation
- âœ… Nacos Discovery & Config
- âœ… MyBatis Helper Starter
- âœ… Redis Cache Starter
- âœ… RabbitMQ
- âœ… **Elasticsearch Starter** (è‡ªå®šä¹‰)
- âœ… Dubbo
- âœ… Common Helper

**æ£€æŸ¥ç»“æœ**: âœ… ä¾èµ–å®Œæ•´

---

### 3. Controllerå±‚ âœ…
**æ–‡ä»¶**: `SearchController.java`

**APIæ¥å£**:
```
POST /api/v1/search/aggregate        - èšåˆæœç´¢
GET  /api/v1/search/api               - æœç´¢API
GET  /api/v1/search/api/{id}          - è·å–APIè¯¦æƒ…
POST /api/v1/search/api/index         - ç´¢å¼•API
DELETE /api/v1/search/api/{id}        - åˆ é™¤APIç´¢å¼•
```

**æ£€æŸ¥ç»“æœ**: âœ… æ¥å£è®¾è®¡åˆç†

---

### 4. Serviceå±‚ âœ…
**æ–‡ä»¶**: `AggregateSearchService.java`

**æ ¸å¿ƒé€»è¾‘**:
- âœ… æ”¯æŒå¤šç±»å‹æœç´¢(API/APP/USER/AUDIT/ALERT)
- âœ… æŒ‰ç›¸å…³æ€§å¾—åˆ†æ’åº
- âœ… åˆ†é¡µå¤„ç†
- âœ… åˆ†é¢ç»Ÿè®¡
- âœ… å¼‚å¸¸å¤„ç†

**æ£€æŸ¥ç»“æœ**: âœ… é€»è¾‘å®Œæ•´

---

## âš ï¸ å‘ç°çš„é—®é¢˜

### é—®é¢˜1: Elasticsearchè¿æ¥é…ç½® âš ï¸
**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ ä¸­

**é—®é¢˜æè¿°**:
```yaml
intellihub:
  elasticsearch:
    hosts:
      - 192.168.200.130:9200
    username:
    password:
```

**æ½œåœ¨é—®é¢˜**:
- IPåœ°å€ç¡¬ç¼–ç ,ä¸åˆ©äºç¯å¢ƒåˆ‡æ¢
- ç”¨æˆ·åå¯†ç ä¸ºç©º,å¦‚æœESå¼€å¯äº†å®‰å…¨è®¤è¯ä¼šè¿æ¥å¤±è´¥
- æ²¡æœ‰è¿æ¥æ± é…ç½®ä¼˜åŒ–

**å»ºè®®ä¿®å¤**:
```yaml
intellihub:
  elasticsearch:
    hosts:
      - ${ES_HOST:localhost}:${ES_PORT:9200}
    username: ${ES_USERNAME:}
    password: ${ES_PASSWORD:}
```

---

### é—®é¢˜2: æ•°æ®åº“è¿æ¥é…ç½® âš ï¸
**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ ä¸­

**é—®é¢˜æè¿°**:
```yaml
spring:
  datasource:
    url: jdbc:mysql://192.168.200.130:3306/intelli_hub_search?...
    username: root
    password: root
```

**æ½œåœ¨é—®é¢˜**:
- IPåœ°å€ç¡¬ç¼–ç 
- ä½¿ç”¨rootè´¦å·,å®‰å…¨æ€§ä½
- å¯†ç æ˜æ–‡å­˜å‚¨

**å»ºè®®ä¿®å¤**:
```yaml
spring:
  datasource:
    url: jdbc:mysql://${DB_HOST:localhost}:${DB_PORT:3306}/${DB_NAME:intelli_hub_search}?...
    username: ${DB_USERNAME:root}
    password: ${DB_PASSWORD:root}
```

---

### é—®é¢˜3: Redisè¿æ¥é…ç½® âš ï¸
**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ ä¸­

**é—®é¢˜æè¿°**:
```yaml
spring:
  redis:
    host: 192.168.200.130
    port: 6379
    password: root
```

**æ½œåœ¨é—®é¢˜**:
- åŒæ ·çš„IPç¡¬ç¼–ç é—®é¢˜
- å¯†ç æ˜æ–‡å­˜å‚¨

**å»ºè®®ä¿®å¤**:
```yaml
spring:
  redis:
    host: ${REDIS_HOST:localhost}
    port: ${REDIS_PORT:6379}
    password: ${REDIS_PASSWORD:}
```

---

### é—®é¢˜4: ç´¢å¼•åˆå§‹åŒ–å¯èƒ½å¤±è´¥ âš ï¸
**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ ä¸­

**ä½ç½®**: `ApiIndexService.java:34-46`

```java
@PostConstruct
public void initIndex() {
    try {
        if (!elasticsearchTemplate.indexExists(IndexConstants.INDEX_API)) {
            Map<String, Object> mappings = new HashMap<>();
            elasticsearchTemplate.createIndex(IndexConstants.INDEX_API, mappings);
        }
    } catch (Exception e) {
        log.warn("åˆå§‹åŒ– API ç´¢å¼•å¤±è´¥ï¼ˆES å¯èƒ½æœªå¯åŠ¨ï¼‰: {}", e.getMessage());
    }
}
```

**æ½œåœ¨é—®é¢˜**:
- å¦‚æœESæœªå¯åŠ¨,ç´¢å¼•åˆ›å»ºå¤±è´¥ä½†æœåŠ¡ç»§ç»­è¿è¡Œ
- mappingsä¸ºç©º,æ²¡æœ‰å®šä¹‰å­—æ®µæ˜ å°„
- åç»­æœç´¢å¯èƒ½å› ä¸ºç´¢å¼•ä¸å­˜åœ¨è€Œå¤±è´¥

**å»ºè®®ä¿®å¤**:
1. æ·»åŠ å¥åº·æ£€æŸ¥,ç¡®ä¿ESå¯ç”¨
2. å®šä¹‰å®Œæ•´çš„ç´¢å¼•æ˜ å°„
3. æä¾›ç´¢å¼•é‡å»ºæ¥å£

---

### é—®é¢˜5: åˆ†é¡µé€»è¾‘åœ¨å†…å­˜ä¸­å¤„ç† âš ï¸
**ä¸¥é‡ç¨‹åº¦**: ğŸŸ  ä¸­é«˜

**ä½ç½®**: `AggregateSearchService.java:91-95`

```java
// åˆ†é¡µå¤„ç†ï¼ˆç®€å•å®ç°ï¼Œå®é™…åº”åœ¨ ES å±‚é¢å¤„ç†ï¼‰
int from = (request.getPage() - 1) * request.getSize();
int to = Math.min(from + request.getSize(), allItems.size());
List<AggregateSearchResponse.SearchItem> pagedItems = 
        from < allItems.size() ? allItems.subList(from, to) : new ArrayList<>();
```

**é—®é¢˜æè¿°**:
- å…ˆè·å–æ‰€æœ‰ç»“æœ(æœ€å¤š300æ¡),å†åœ¨å†…å­˜ä¸­åˆ†é¡µ
- å¦‚æœæ•°æ®é‡å¤§,æ€§èƒ½å·®ä¸”å†…å­˜å ç”¨é«˜
- æ³¨é‡Šå·²è¯´æ˜"å®é™…åº”åœ¨ ES å±‚é¢å¤„ç†"

**å½±å“**:
- æ€§èƒ½é—®é¢˜
- å†…å­˜å ç”¨
- æ— æ³•æ”¯æŒå¤§æ•°æ®é‡æœç´¢

**å»ºè®®ä¿®å¤**:
åœ¨ESæŸ¥è¯¢æ—¶å°±è¿›è¡Œåˆ†é¡µ,è€Œä¸æ˜¯è·å–æ‰€æœ‰æ•°æ®åå†åˆ†é¡µ

---

### é—®é¢˜6: ç¼ºå°‘æ•°æ®åº“è¡¨ç»“æ„ âš ï¸
**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ ä¸­

**é—®é¢˜æè¿°**:
- é…ç½®äº†MySQLæ•°æ®åº“ `intelli_hub_search`
- ä½†æ²¡æœ‰æ‰¾åˆ°å»ºè¡¨è„šæœ¬
- ä¸ç¡®å®šæ•°æ®åº“ç”¨é€”

**å»ºè®®**:
1. å¦‚æœä¸éœ€è¦æ•°æ®åº“,ç§»é™¤ç›¸å…³é…ç½®
2. å¦‚æœéœ€è¦,æä¾›å»ºè¡¨è„šæœ¬

---

### é—®é¢˜7: æ¶ˆæ¯é˜Ÿåˆ—ä¾èµ–é”™è¯¯ âš ï¸
**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ ä¸­

**é—®é¢˜æè¿°**:
- pom.xmlä¸­å¼•å…¥äº†RabbitMQä¾èµ–
- ä½†é¡¹ç›®å®é™…ä½¿ç”¨çš„æ˜¯Kafka
- å¼•å…¥äº†ä¸éœ€è¦çš„ä¾èµ–,å¯èƒ½å¯¼è‡´å†²çª

**å»ºè®®**:
1. ç§»é™¤RabbitMQä¾èµ–
2. ç¡®è®¤Kafkaä¾èµ–å·²æ­£ç¡®å¼•å…¥
3. æ·»åŠ Kafkaé…ç½®(å¦‚æœéœ€è¦)

---

## ğŸ“Š é—®é¢˜ç»Ÿè®¡

| é—®é¢˜ç±»å‹ | æ•°é‡ | ä¸¥é‡ç¨‹åº¦ |
|---------|------|----------|
| é…ç½®ç¡¬ç¼–ç  | 3 | ä¸­ |
| ç´¢å¼•åˆå§‹åŒ– | 1 | ä¸­ |
| æ€§èƒ½é—®é¢˜ | 1 | ä¸­é«˜ |
| ç¼ºå°‘è„šæœ¬ | 1 | ä¸­ |
| ä¾èµ–é”™è¯¯ | 1 | ä¸­ |
| **æ€»è®¡** | **7** | - |

---

## ğŸ”§ å»ºè®®ä¿®å¤ä¼˜å…ˆçº§

### P0 (ç«‹å³ä¿®å¤)
1. **ä¿®å¤åˆ†é¡µé€»è¾‘** - æ€§èƒ½é—®é¢˜,å½±å“ç”¨æˆ·ä½“éªŒ
2. **å®Œå–„ç´¢å¼•æ˜ å°„** - ç¡®ä¿æœç´¢åŠŸèƒ½æ­£å¸¸

### P1 (è¿‘æœŸä¿®å¤)
3. **é…ç½®å¤–éƒ¨åŒ–** - ä½¿ç”¨ç¯å¢ƒå˜é‡,æ”¯æŒå¤šç¯å¢ƒéƒ¨ç½²
4. **æ·»åŠ å¥åº·æ£€æŸ¥** - ç¡®ä¿ESè¿æ¥æ­£å¸¸

### P2 (åç»­ä¼˜åŒ–)
5. **æ·»åŠ æ•°æ®åº“è„šæœ¬** - å®Œå–„æ–‡æ¡£
6. **ç§»é™¤RabbitMQä¾èµ–** - é¡¹ç›®ä½¿ç”¨Kafka,ç§»é™¤ä¸éœ€è¦çš„ä¾èµ–
7. **å®‰å…¨åŠ å›º** - å¯†ç åŠ å¯†,æƒé™æ§åˆ¶

---

## âœ… ä»£ç è´¨é‡è¯„ä¼°

### ä¼˜ç‚¹
- âœ… ä»£ç ç»“æ„æ¸…æ™°,åˆ†å±‚åˆç†
- âœ… å¼‚å¸¸å¤„ç†å®Œå–„
- âœ… æ—¥å¿—è®°å½•è¯¦ç»†
- âœ… ä½¿ç”¨äº†è‡ªå®šä¹‰Elasticsearch Starter
- âœ… æ”¯æŒå¤šç±»å‹èšåˆæœç´¢

### éœ€è¦æ”¹è¿›
- âš ï¸ é…ç½®ç¡¬ç¼–ç ,ä¸åˆ©äºéƒ¨ç½²
- âš ï¸ åˆ†é¡µé€»è¾‘éœ€è¦ä¼˜åŒ–
- âš ï¸ ç´¢å¼•æ˜ å°„éœ€è¦å®Œå–„
- âš ï¸ ç¼ºå°‘å•å…ƒæµ‹è¯•

---

## ğŸš€ å¿«é€Ÿä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®å¤é…ç½®ç¡¬ç¼–ç 

**åˆ›å»º**: `application-dev.yml`
```yaml
intellihub:
  elasticsearch:
    hosts:
      - 192.168.200.130:9200
```

**åˆ›å»º**: `application-prod.yml`
```yaml
intellihub:
  elasticsearch:
    hosts:
      - ${ES_HOST}:${ES_PORT}
```

**ä¿®æ”¹**: `application.yml`
```yaml
intellihub:
  elasticsearch:
    hosts:
      - ${ES_HOST:localhost}:${ES_PORT:9200}
    username: ${ES_USERNAME:}
    password: ${ES_PASSWORD:}
```

---

### 2. å®Œå–„ç´¢å¼•æ˜ å°„

**ä¿®æ”¹**: `ApiIndexService.java`
```java
@PostConstruct
public void initIndex() {
    try {
        if (!elasticsearchTemplate.indexExists(IndexConstants.INDEX_API)) {
            Map<String, Object> mappings = buildApiMappings();
            elasticsearchTemplate.createIndex(IndexConstants.INDEX_API, mappings);
            log.info("API ç´¢å¼•åˆ›å»ºæˆåŠŸ: {}", IndexConstants.INDEX_API);
        }
    } catch (Exception e) {
        log.error("åˆå§‹åŒ– API ç´¢å¼•å¤±è´¥: {}", e.getMessage(), e);
        throw new RuntimeException("ESåˆå§‹åŒ–å¤±è´¥,æœåŠ¡æ— æ³•å¯åŠ¨", e);
    }
}

private Map<String, Object> buildApiMappings() {
    Map<String, Object> mappings = new HashMap<>();
    // å®šä¹‰å­—æ®µæ˜ å°„
    Map<String, Object> properties = new HashMap<>();
    properties.put("name", Map.of("type", "text", "analyzer", "ik_max_word"));
    properties.put("description", Map.of("type", "text", "analyzer", "ik_max_word"));
    properties.put("path", Map.of("type", "keyword"));
    properties.put("method", Map.of("type", "keyword"));
    // ... æ›´å¤šå­—æ®µ
    mappings.put("properties", properties);
    return mappings;
}
```

---

### 3. ä¼˜åŒ–åˆ†é¡µé€»è¾‘

**ä¿®æ”¹**: `AggregateSearchService.java`
```java
// åœ¨ESå±‚é¢åˆ†é¡µ,è€Œä¸æ˜¯å†…å­˜åˆ†é¡µ
private void searchApis(AggregateSearchRequest request, String tenantId,
                        List<AggregateSearchResponse.SearchItem> items,
                        Map<String, Long> typeCounts) {
    try {
        SearchResponse<ApiDoc> apiResponse = apiIndexService.searchApis(
                request.getKeyword(),
                tenantId,
                request.getFilters(),
                request.getPage(),  // ä½¿ç”¨è¯·æ±‚çš„åˆ†é¡µå‚æ•°
                request.getSize(),
                request.isHighlight()
        );
        // ... å¤„ç†ç»“æœ
    }
}
```

---

## ğŸ“ æ€»ç»“

### æœåŠ¡çŠ¶æ€: âš ï¸ å¯è¿è¡Œä½†éœ€ä¼˜åŒ–

**æ ¸å¿ƒé—®é¢˜**:
1. é…ç½®ç¡¬ç¼–ç  - å½±å“éƒ¨ç½²
2. åˆ†é¡µæ€§èƒ½ - å½±å“ç”¨æˆ·ä½“éªŒ
3. ç´¢å¼•æ˜ å°„ - å½±å“æœç´¢è´¨é‡

**å»ºè®®**:
- ä¼˜å…ˆä¿®å¤P0é—®é¢˜
- é€æ­¥å®Œå–„é…ç½®å’Œæ–‡æ¡£
- æ·»åŠ å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•

**é¢„è®¡ä¿®å¤æ—¶é—´**: 1-2å¤©

---

*æ£€æŸ¥æ—¶é—´: 2025-01-04*  
*æ£€æŸ¥äºº: IntelliHub Team*  
*æŠ¥å‘Šç‰ˆæœ¬: v1.0*
