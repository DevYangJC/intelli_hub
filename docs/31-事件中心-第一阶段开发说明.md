# 第一阶段开发说明

## 已完成的工作

### 1. 事件定义初始化脚本
- 文件：`intelli-event-service/src/main/resources/db/init_events.sql`
- 内容：6个事件定义（api.published, api.updated, api.offline, api.deleted, alert.triggered, alert.resolved）

### 2. API 服务事件发布集成
- 新增文件：`intelli-api-platform-service/src/main/java/com/intellihub/api/service/ApiEventPublisher.java`
- 修改文件：`intelli-api-platform-service/src/main/java/com/intellihub/api/service/impl/ApiInfoServiceImpl.java`
- 修改文件：`intelli-api-platform-service/pom.xml`（添加 Kafka 依赖）

**实现说明：**
- 创建了新的 `ApiEventPublisher` 专门用于事件中心
- 保持原有的 `ApiRouteEventPublisher` 不变（继续使用 Redis 通知网关）
- 在 `publishApi`、`offlineApi`、`deleteApi` 方法中同时调用两个发布器
- 使用 Builder 模式优化代码风格

## 事件流转架构

```
┌─────────────┐
│  API 服务   │
└──────┬──────┘
       │ 1. 发布事件
       v
┌─────────────────────────────┐
│  Kafka Topic                │
│  intellihub-event           │
└──────┬──────────────────────┘
       │ 2. 消费事件
       v
┌─────────────────────────────┐
│  事件服务 EventConsumer     │
│  - 监听 Kafka Topic         │
│  - 查询订阅列表             │
│  - 分发给订阅者             │
│  - 记录消费日志             │
└──────┬──────────────────────┘
       │ 3. 分发事件
       v
┌─────────────────────────────┐
│  订阅者                     │
│  - 网关服务 (Webhook)       │
│  - 审计服务 (Webhook)       │
│  - 文档服务 (Webhook)       │
│  - 监控服务 (Webhook)       │
└─────────────────────────────┘
```

## 编译说明

### 问题
事件服务的 `EventConsumer` 中引用了 Kafka 相关的类，但是 IDE 可能报错找不到这些类。

### 原因
`kafka-spring-boot-starter` 模块需要先编译并安装到本地 Maven 仓库。

### 解决方案

#### 方案1：使用 Maven 命令编译（推荐）
```bash
cd d:\Develop\Code_github\intelli_hub\intellihub-parent
mvn clean install -DskipTests -pl inner-intergration/kafka-spring-boot-starter -am
```

#### 方案2：在 IDE 中操作
1. 在 IDEA 中打开 Maven 面板
2. 找到 `inner-intergration/kafka-spring-boot-starter` 模块
3. 右键选择 `Maven` -> `Reimport`
4. 或者执行 `Maven` -> `Install`

#### 方案3：编译整个项目
```bash
cd d:\Develop\Code_github\intelli_hub\intellihub-parent
mvn clean install -DskipTests
```

### 编译后操作
1. 刷新 IDE 的 Maven 依赖
2. 重新导入项目
3. 检查 `EventConsumer` 中的 Kafka 相关类是否可以正常引用

## 下一步工作

### 1. 在治理服务中集成告警事件发布
- [ ] 创建 `AlertEventPublisher`
- [ ] 在告警触发和恢复时发布事件
- [ ] 添加 Kafka 依赖

### 2. 在网关服务中实现 API 事件订阅
- [ ] 创建 Webhook 接口接收事件
- [ ] 实现路由配置刷新逻辑
- [ ] 在事件中心配置订阅关系

### 3. 测试事件流转
- [ ] 测试 API 发布事件
- [ ] 测试 API 下线事件
- [ ] 测试 API 删除事件
- [ ] 测试告警事件
- [ ] 验证订阅者是否正确接收事件

## 注意事项

### 1. 双发布机制
目前 API 服务同时使用两种事件发布方式：
- **Redis Pub/Sub**：原有机制，网关服务通过 Redis 订阅实时接收路由变更
- **Kafka 事件中心**：新机制，通过事件中心实现更灵活的事件订阅和分发

**为什么保留 Redis 方式？**
- 保证向后兼容，不影响现有功能
- Redis Pub/Sub 延迟更低，适合实时路由刷新
- Kafka 事件中心提供更完整的事件管理和追踪

**未来优化方向：**
- 网关服务改为订阅事件中心的事件
- 逐步迁移到统一的事件中心机制
- 移除 Redis Pub/Sub 方式

### 2. 事件数据格式
事件消息格式：
```json
{
  "tenantId": "租户ID",
  "eventCode": "事件编码",
  "source": "事件源服务",
  "data": {
    "apiId": "API ID",
    "apiPath": "API路径",
    "method": "请求方法",
    "publishedAt": "发布时间"
  },
  "timestamp": "事件时间戳"
}
```

### 3. 订阅配置
在事件中心需要配置订阅关系：
- 网关服务订阅 `api.published`、`api.updated`、`api.offline`、`api.deleted`
- 审计服务订阅所有 API 事件
- 文档服务订阅 `api.published`、`api.updated`
- 监控服务订阅 `api.published`、`api.offline`

## 常见问题

### Q1: 为什么不直接修改 ApiRouteEventPublisher？
**A:** 因为网关服务还在使用原有的 Redis 订阅机制。直接修改会影响现有功能。创建新的 `ApiEventPublisher` 可以保证向后兼容。

### Q2: EventConsumer 报错找不到 Kafka 类怎么办？
**A:** 需要先编译 `kafka-spring-boot-starter` 模块，然后刷新 IDE 的 Maven 依赖。

### Q3: 事件服务的 EventConsumer 会消费所有事件吗？
**A:** 是的，EventConsumer 会消费 Kafka `intellihub-event` Topic 中的所有事件，然后根据订阅配置分发给订阅者。

### Q4: 如何测试事件发布是否成功？
**A:** 
1. 查看 API 服务日志，确认事件发布成功
2. 查看 Kafka 中的消息（使用 Kafka 工具）
3. 查看事件服务日志，确认消费成功
4. 查看 `event_publish_record` 表，确认发布记录
5. 查看 `event_consume_record` 表，确认消费记录

## 参考文档
- [事件中心设计文档](../intellihub-parent/intelli-event-service/docs/事件中心设计文档.md)
- [事件中心实施计划](./事件中心实施计划.md)
