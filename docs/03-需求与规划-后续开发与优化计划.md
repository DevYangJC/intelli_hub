# IntelliHub 后续开发与优化计划

> 目标：在保持当前"网关统一治理 + 多租户 + API 全生命周期 + 统计告警"的核心闭环稳定的前提下，补齐可扩展能力（聚合搜索、事件中心、AIGC 智能增强），并通过 Starter 化沉淀基础设施能力，让新模块的开发成本可控。

---

## 1. 平台微服务架构总览

当前 `intellihub-parent` 包含以下微服务：

| 微服务 | 职责 | 核心数据 |
|--------|------|----------|
| `intelli-gateway-service` | API 网关，统一入口、路由、鉴权、限流 | 路由规则、访问日志 |
| `intelli-api-platform-service` | API 全生命周期管理（定义、发布、下线、版本） | API 元信息、参数定义、文档 |
| `intelli-app-center-service` | 应用中心（AppKey 管理、订阅授权） | 应用信息、订阅关系、密钥 |
| `intelli-auth-iam-service` | 身份认证与权限（用户、角色、租户） | 用户、角色、权限、租户 |
| `intelli-governance-service` | API 治理（统计、告警、熔断策略） | 调用统计、告警规则、告警记录 |
| `intelli-log-audit-service` | 操作审计与日志留痕 | 审计日志 |
| `intelli-search-service` | 聚合搜索服务（ES 索引与检索） | ES 索引（API/文档/审计） |
| `intelli-event-service` | 事件中心（领域事件发布与订阅） | 事件流、事件日志 |
| `intelli-aigc-service` | AIGC 智能增强（AI 分析与生成） | Prompt 模板、调用日志 |

---

## 2. 聚合搜索能力设计（intelli-search-service）

### 2.1 设计目标

- 提供全平台统一搜索入口，用户可一次查询跨多个微服务的数据。
- 支持关键词搜索、高亮、联想、过滤、分页。
- 数据来源多样化，通过事件驱动实现准实时同步.

### 2.2 涉及的微服务与数据来源

聚合搜索需从以下微服务获取数据并建立 ES 索引：

```
┌─────────────────────────────────────────────────────────────┐
│                      数据来源                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐ │
│  │ api-     │    │ app-     │    │governance │    │ auth-    │ │
│  │ platform │    │ center   │    │ service   │    │ iam      │ │
│  │ ──────── │    │ ──────── │    │ ──────── │    │ ──────── │ │
│  │ • API 名称 │    │ • 应用名称 │    │ • 告警规则 │    │ • 用户信息 │ │
│  │ • API 路径 │    │ • AppKey   │    │ • 告警记录 │    │ • 角色/权限 │ │
│  │ • API 描述 │    │ • 订阅关系 │    │ • 统计数据 │    │           │ │
│  │ • 参数/标签 │    │ • 应用描述 │    │           │    │           │ │
│  └───────────┘    └───────────┘    └───────────┘    └───────────┘ │
│                                                             │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐             │
│  │ log-     │    │ event-    │    │ aigc-    │             │
│  │ audit    │    │ service   │    │ service  │             │
│  │ ──────── │    │ ──────── │    │ ──────── │             │
│  │ • 审计日志 │    │ • 事件流  │    │ • Prompt 模板 │             │
│  │           │    │ • 事件日志 │    │ • 调用日志  │             │
│  └───────────┘    └───────────┘    └───────────┘             │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2.3 ES 索引设计

| 索引名称 | 数据来源 | 核心字段 | 用途 |
|----------|----------|----------|------|
| `idx_api` | `api-platform-service` | id, name, path, method, description, tags, groupId, status, tenantId, updatedAt | API 搜索 |
| `idx_app` | `app-center-service` | id, appName, appKey, description, status, tenantId, updatedAt | 应用搜索 |
| `idx_audit` | `log-audit-service` | id, userId, action, resourceType, resourceId, ip, traceId, tenantId, createdAt | 审计检索 |
| `idx_alert` | `governance-service` | id, ruleName, apiId, alertLevel, triggerTime, tenantId | 告警搜索 |
| `idx_user` | `auth-iam-service` | id, username, nickname, email, roles, tenantId | 用户搜索 |

### 2.4 聚合搜索实现方式

#### 2.4.1 数据同步策略

```
┌─────────────────────────────────────────────────────────────┐
│                      数据同步链路                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  方式一：事件驱动（推荐，准实时）                            │
│  ┌──────────┐    Kafka     ┌──────────────┐    ES API      │
│  │ 业务服务 │ ──────────▶  │ search-service│ ──────────▶ ES │
│  │ 发布事件 │   事件Topic  │  消费 & 索引  │               │
│  └──────────┘              └──────────────┘               │
│                                                             │
│  方式二：定时同步（兜底，全量/增量）                         │
│  ┌──────────┐   Dubbo/HTTP  ┌──────────────┐    ES API     │
│  │ 业务服务 │ ◀──────────── │ search-service│ ──────────▶ ES│
│  │ 查询接口 │   定时拉取    │ 定时任务      │               │
│  └──────────┘              └──────────────┘               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

- **P0 阶段**：定时全量/增量同步（基于 `updated_at` 字段）
- **P1 阶段**：事件驱动增量同步（订阅 `event-service` 的领域事件）

#### 2.4.2 聚合查询接口

`intelli-search-service` 对外提供统一搜索 API：

```java
// 统一聚合搜索接口
POST /api/v1/search/aggregate
{
  "keyword": "用户管理",           // 搜索关键词
  "types": ["api", "app", "user"], // 搜索范围（可选）
  "filters": {                     // 过滤条件
    "status": "online",
    "tags": ["核心", "用户"]
  },
  "page": 1,
  "size": 20,
  "highlight": true                // 是否高亮
}

// 响应
{
  "total": 35,
  "items": [
    { "type": "api", "id": "123", "name": "获取用户信息", "highlight": "获取<em>用户</em>信息", ... },
    { "type": "app", "id": "456", "name": "用户中心", ... },
    ...
  ],
  "facets": {                      // 分面聚合
    "types": { "api": 20, "app": 10, "user": 5 },
    "tags": { "核心": 15, "用户": 12 }
  }
}
```

#### 2.4.3 搜索服务与各微服务的交互

| 交互方向 | 通信方式 | 说明 |
|----------|----------|------|
| `search-service` ← 业务服务 | **Kafka 事件** | 业务服务发布变更事件，search-service 订阅消费 |
| `search-service` → 业务服务 | **Dubbo RPC** | 定时任务拉取数据（兜底/全量同步） |
| 前端/其他服务 → `search-service` | **HTTP REST** | 调用搜索 API |

### 2.5 多租户隔离

- ES 索引数据**必须包含 `tenantId` 字段**
- 所有查询自动注入 `tenantId` 过滤条件
- 可选：按租户分索引（适用于大租户场景）

### 2.6 开发计划

| 阶段 | 任务 | 预估工期 | 状态 |
|------|------|----------|------|
| P0 | ES 环境搭建 + `elasticsearch-spring-boot-starter` 封装 | 2 天 | ✅ 已完成 |
| P0 | `idx_api` 索引设计与定时同步（api-platform → ES） | 2 天 | ✅ 已完成 |
| P0 | 基础搜索 API（关键词 + 分页） | 1 天 | ✅ 已完成 |
| P1 | `idx_app`、`idx_user` 索引接入 | 2 天 | ✅ 已完成 |
| P1 | 高亮、分面聚合 | 2 天 | ✅ 已完成 |
| P2 | `idx_audit`、`idx_alert` 索引接入 | 2 天 | 暂不实现 |
| P2 | 事件驱动增量同步（对接 event-service） | 2 天 | 暂不实现 |
| P2 | 搜索日志 & 热词统计 | 1 天 | 暂不实现 |

---

## 3. 事件中心设计（intelli-event-service）

### 3.1 设计目标

- 将关键业务动作"**事件化**"，解耦服务之间的直接依赖.
- 提供统一的事件发布/订阅机制，支持事件溯源与追踪.
- 为聚合搜索、审计日志、AIGC 分析等提供数据驱动基础.

### 3.2 事件中心架构

```
┌─────────────────────────────────────────────────────────────────┐
│                      intelli-event-service                      │
│                       （事件中心）                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │                    Event Bus（Kafka）                     │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │ │
│  │  │ api-events  │  │ app-events  │  │alert-events │ ...   │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘       │ │
│  └───────────────────────────────────────────────────────────┘ │
│                              ▲                                  │
│                              │ 发布事件                         │
│  ┌───────────┬───────────┬───────────┬───────────┐             │
│  │ api-      │ app-      │governance │ auth-     │             │
│  │ platform  │ center    │ service   │ iam       │             │
│  └───────────┴───────────┴───────────┴───────────┘             │
│                              │                                  │
│                              ▼ 消费事件                         │
│  ┌───────────┬───────────┬───────────┬───────────┐             │
│  │ search-   │ log-audit │ aigc-     │ gateway   │             │
│  │ service   │ service   │ service   │ service   │             │
│  │ (索引更新) │ (审计记录) │ (智能分析) │ (路由刷新) │             │
│  └───────────┴───────────┴───────────┴───────────┘             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3.3 领域事件定义

| 事件类型 | 发布者 | 消费者 | 说明 |
|----------|--------|--------|------|
| `ApiPublished` | api-platform | search, gateway | API 发布上线 |
| `ApiOfflined` | api-platform | search, gateway | API 下线 |
| `ApiUpdated` | api-platform | search | API 信息变更 |
| `AppCreated` | app-center | search | 应用创建 |
| `AppKeyRotated` | app-center | gateway, audit | 密钥轮换 |
| `SubscriptionChanged` | app-center | gateway, audit | 订阅关系变更 |
| `RouteChanged` | governance | gateway | 路由规则变更 |
| `AlertTriggered` | governance | aigc, audit | 告警触发 |
| `UserCreated` | auth-iam | search | 用户创建 |
| `RoleChanged` | auth-iam | gateway | 角色权限变更 |

### 3.4 事件模型（Envelope）

```java
public class DomainEvent {
    private String eventId;        // 事件唯一ID（UUID）
    private String eventType;      // 事件类型（如 ApiPublished）
    private Long tenantId;         // 租户ID
    private Long userId;           // 操作用户ID
    private String traceId;        // 链路追踪ID
    private LocalDateTime occurredAt; // 发生时间
    private Object payload;        // 事件载荷（具体业务数据）
    private Map<String, String> metadata; // 扩展元数据
}
```

### 3.5 Starter 封装

**`event-bus-spring-boot-starter`**：

- 统一事件发布接口：`EventPublisher.publish(DomainEvent event)`
- 统一事件订阅注解：`@EventListener(type = "ApiPublished")`
- 支持本地事件（Spring Event）与分布式事件（Kafka）切换
- 内置幂等处理：基于 `eventId` 去重
- 事件日志：自动记录事件发布/消费日志

### 3.6 开发计划

| 阶段 | 任务 | 预估工期 | 状态 |
|------|------|----------|------|
| P0 | 事件模型设计 + Kafka Topic 规划 | 1 天 | ✅ 已完成 |
| P0 | 事件发布服务（同步/异步） | 1 天 | ✅ 已完成 |
| P0 | 事件订阅管理（创建/更新/删除/暂停/恢复） | 1 天 | ✅ 已完成 |
| P0 | Kafka 事件消费者 | 1 天 | ✅ 已完成 |
| P0 | Webhook 处理器（策略模式） | 1 天 | ✅ 已完成 |
| P0 | 事件过滤器（SpEL 表达式） | 1 天 | ✅ 已完成 |
| P0 | 重试机制（固定间隔/指数退避） | 1 天 | ✅ 已完成 |
| P0 | 消费记录管理与查询 | 1 天 | ✅ 已完成 |
| P2 | `event-bus-spring-boot-starter` 独立封装 | 2 天 | 暂不实现（已集成在服务内） |
| P2 | ServiceHandler / MqHandler 处理器 | 2 天 | 暂不实现 |
| P2 | 事件回放与追踪功能 | 2 天 | 暂不实现 |

---

## 4. AIGC 智能增强设计（intelli-aigc-service）

### 4.1 设计目标

- 以"**可控成本 + 可审计**"的方式引入 LLM 能力.
- 为平台各模块提供智能分析、内容生成、运维建议等 AI 能力.

### 4.2 AIGC 服务涉及的平台能力

```
┌─────────────────────────────────────────────────────────────────┐
│                      intelli-aigc-service                       │
│                     （AIGC 智能增强服务）                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                   AI 能力层                              │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐   │   │
│  │  │ 文本生成 │ │ 内容分析 │ │ 智能问答 │ │ 代码生成 │   │   │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│                              ▼                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                  平台能力对接                            │   │
│  ├─────────────────────────────────────────────────────────┤   │
│  │                                                          │   │
│  │  📄 API 文档生成          → api-platform-service         │   │
│  │     • 根据 API 定义自动生成接口文档                       │   │
│  │     • 自动补充参数说明、示例值                            │   │
│  │     • 生成错误码说明                                     │   │
│  │                                                          │   │
│  │  💻 SDK 代码生成          → api-platform-service         │   │
│  │     • 根据 API 定义生成多语言 SDK 调用示例                │   │
│  │     • 支持 Java、Python、JavaScript、Go 等               │   │
│  │                                                          │   │
│  │  🚨 告警智能分析          → governance-service           │   │
│  │     • 分析告警根因，给出可能原因                          │   │
│  │     • 提供修复建议与操作指引                              │   │
│  │     • 异常模式识别与聚类                                  │   │
│  │                                                          │   │
│  │  📊 调用分析报告          → governance-service           │   │
│  │     • 生成 API 调用趋势分析报告                           │   │
│  │     • 识别异常调用模式                                    │   │
│  │     • 容量规划建议                                        │   │
│  │                                                          │   │
│  │  🔍 智能搜索增强          → search-service               │   │
│  │     • 搜索意图理解                                        │   │
│  │     • 相关性排序优化                                      │   │
│  │     • 查询改写与扩展                                      │   │
│  │                                                          │   │
│  │  🤖 智能问答助手          → 全平台                        │   │
│  │     • 平台使用引导                                        │   │
│  │     • API 接入咨询                                        │   │
│  │     • 故障排查辅助                                        │   │
│  │                                                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 4.3 AIGC 能力详细说明

#### 4.3.1 API 文档自动生成

| 输入 | 输出 | 调用方 |
|------|------|--------|
| API 定义（路径、方法、参数、响应结构） | Markdown/HTML 格式文档 | api-platform-service |

**场景示例**：
- 用户创建 API 后，自动生成接口文档草稿
- 根据参数类型自动补充示例值
- 生成调用示例代码

#### 4.3.2 SDK 代码生成

| 输入 | 输出 | 支持语言 |
|------|------|----------|
| API 定义 + 目标语言 | 可直接运行的 SDK 调用代码 | Java, Python, JavaScript, Go, cURL |

#### 4.3.3 告警智能分析

| 输入 | 输出 | 调用时机 |
|------|------|----------|
| 告警详情 + 近期调用日志 + 历史告警 | 根因分析 + 修复建议 | 告警触发时 |

**分析维度**：
- 错误率异常：分析错误码分布、请求参数特征
- 响应延迟：分析慢请求特征、下游依赖状态
- 流量突增：分析调用来源、是否为攻击

#### 4.3.4 智能问答助手

**应用场景**：
- "如何接入某个 API？"
- "这个告警是什么意思？"
- "为什么我的请求返回 403？"

### 4.4 与各微服务的交互

| 微服务 | 交互方式 | 数据流 |
|--------|----------|--------|
| `api-platform-service` | Dubbo RPC | 获取 API 定义 → 返回文档/SDK |
| `governance-service` | Dubbo RPC / 事件 | 获取告警详情 → 返回分析结果 |
| `search-service` | HTTP | 接收搜索 Query → 返回意图分析 |
| `event-service` | Kafka 消费 | 订阅 AlertTriggered 事件 → 触发分析 |

### 4.5 Starter 封装

**`aigc-client-spring-boot-starter`**：
```yaml
intellihub:
  aigc:
    provider: openai          # openai / tongyi / volcano / local
    api-key: ${AIGC_API_KEY}
    base-url: https://api.openai.com/v1
    model: gpt-4o-mini
    timeout: 30s
    retry: 3
    rate-limit: 100/min       # 限流
    log-desensitize: true     # 日志脱敏
```

**核心接口**：
```java
public interface AigcClient {
    // 文本生成
    String generate(String prompt, Map<String, Object> variables);
    
    // 流式生成
    Flux<String> generateStream(String prompt, Map<String, Object> variables);
    
    // 结构化输出
    <T> T generateStructured(String prompt, Class<T> responseType);
}
```

### 4.6 开发计划

| 阶段 | 任务 | 预估工期 | 状态 |
|------|------|----------|------|
| P0 | `aigc-client-spring-boot-starter` 封装 | 2 天 | ✅ 已完成 |
| P0 | 百度千帆平台适配（多模型统一调用） | 2 天 | ✅ 已完成 |
| P1 | 告警智能分析功能 | 3 天 | ✅ 已完成 |
| P1 | API 文档自动生成 | 2 天 | 暂不实现（已有 SpringDoc） |
| P2 | SDK 代码生成 | 2 天 | 🔲 未开始 |
| P2 | 智能问答助手 | 3 天 | ✅ 已完成 |

---

## 5. 日志审计（intelli-log-audit-service）

> **状态：🔲 未开始** - 该服务暂未创建，作为后续扩展功能保留

### 5.1 目标

- 形成操作留痕（谁在何时对什么资源做了什么动作）.
- 支持审计查询与报表导出.

### 5.2 审计事件模型

```java
public class AuditLog {
    private Long id;
    private Long userId;           // 操作用户
    private Long tenantId;         // 租户
    private String action;         // 动作（CREATE/UPDATE/DELETE/QUERY）
    private String resourceType;   // 资源类型（API/APP/USER...）
    private String resourceId;     // 资源ID
    private String beforeData;     // 变更前（JSON）
    private String afterData;      // 变更后（JSON）
    private String ip;             // 客户端IP
    private String userAgent;      // UA
    private String traceId;        // 链路ID
    private LocalDateTime createdAt;
}
```

### 5.3 写入链路

- **P0**：同步写 DB（简单可靠）
- **P1**：异步写 Kafka → 消费入库（高吞吐）

### 5.4 Starter 封装

**`audit-spring-boot-starter`**：
- 基于 AOP 拦截 controller/service
- 支持注解：`@Audit(action="CREATE", resourceType="API")`
- 自动采集 `UserContextHolder`、request header、traceId

---

## 6. Starter 封装总表

| Starter | 类型 | 目标 | 优先级 | 状态 |
|---------|------|------|--------|------|
| `elasticsearch-spring-boot-starter` | 新增 | 统一 ES Client 与 DSL/分页/异常 | P0 | ✅ 已完成 |
| `kafka-spring-boot-starter` | 增强 | 统一 Producer/Consumer、事件 envelope | P0 | ✅ 已完成 |
| `redis-cache-spring-boot-starter` | 增强 | 统一序列化/Key 规范/工具类能力固化 | P0 | ✅ 已完成 |
| `mybatis-helper-spring-boot-starter` | 增强 | MyBatis-Plus 增强、多租户拦截器 | P0 | ✅ 已完成 |
| `aop-spring-boot-starter` | 新增 | 通用 AOP 切面封装 | P0 | ✅ 已完成 |
| `event-bus-spring-boot-starter` | 新增 | 领域事件发布/订阅规范 | P2 | 暂不实现（已集成在 event-service） |
| `aigc-client-spring-boot-starter` | 新增 | AI Client 抽象（百度千帆） | P0 | ✅ 已完成 |
| `audit-spring-boot-starter` | 新增 | 操作审计 AOP + 写入链路 | P2 | 🔲 未开始 |

---

## 7. 总体里程碑（Roadmap）

| 里程碑 | 周期 | 目标 | 交付物 | 状态 |
|--------|------|------|--------|------|
| **M0** | 1-2 天 | 基础设施收敛 | 依赖清理、配置规范化 | ✅ 已完成 |
| **M1** | 5-10 天 | 聚合搜索能力 | ES Starter、search-service、统一搜索 API、API/APP/User 索引、定时同步 | ✅ 已完成 |
| **M2** | 3-7 天 | 事件中心 | event-service、事件发布/订阅/消费、Webhook处理、重试机制、过滤器 | ✅ 已完成 |
| **M3** | 3-7 天 | 日志审计 | log-audit-service、audit-starter | 🔲 暂不实现 |
| **M4** | 持续迭代 | AIGC 智能增强 | aigc-client-starter、告警分析、文档生成 | ⏳ 进行中（starter已完成） |

---

## 8. 当前进度总结

### ✅ 已完成
1. **聚合搜索服务（M1）**：ES Starter、API/APP/User 索引、定时同步、聚合搜索 API、高亮、分面统计
2. **事件中心（M2）**：事件发布/订阅服务、Kafka 消费者、Webhook 处理器、SpEL 过滤器、重试机制、消费记录管理
3. **基础 Starters**：elasticsearch、kafka、redis-cache、mybatis-helper、aop、aigc-client
4. **AIGC基础设施（M4）**：aigc-client-spring-boot-starter（百度千帆API封装、同步/流式调用）
5. **告警智能分析（M4）**：基于AI的告警根因分析和处理建议
6. **智能问答助手（M4）**：QaService 支持对话历史、问题类型、建议问题

### ⏳ 进行中
1. **AIGC 智能增强（M4）**：SDK代码生成（可选）

### 🔲 暂不实现（可后续扩展）
1. **日志审计服务（M3）**：log-audit-service、audit-starter
3. **事件中心扩展**：event-bus-starter 独立封装、ServiceHandler、MqHandler、事件回放
4. **搜索扩展**：idx_audit/idx_alert 索引、事件驱动增量同步、搜索日志

---

## 9. 变更记录

- 2025-12-30：重构《后续开发与优化计划》；详细说明聚合搜索能力（涉及微服务、数据来源、同步方式）；补充事件中心设计；完善 AIGC 服务与平台能力的对接说明.
- 2026-01-09：根据代码实际完成度更新文档状态；事件中心核心功能已完成（发布/订阅/消费/Webhook/重试/过滤）；聚合搜索基础功能已完成（ES Starter、API/APP/User 索引、定时同步）；标记日志审计和 AIGC 为暂不实现。
- 2026-01-09：完成 aigc-client-spring-boot-starter 封装；基于百度千帆平台统一调用多模型（ERNIE、DeepSeek、Qwen等）；支持同步/流式调用；intelli-aigc-service 基础 REST API 实现。
- 2026-01-09：完成告警智能分析功能；AlertAnalysisService 基于AI分析告警信息，提供根因分析、影响范围、处理建议和预防措施；支持完整分析和快速分析两种模式。
- 2026-01-09：API 文档自动生成标记为暂不实现（已有 SpringDoc 自动生成）；清理前端 AIGC 相关代码。
- 2026-01-09：完成智能问答助手；QaService 基于 AI 回答 API 使用、错误排查、最佳实践问题；支持对话历史和建议问题。
