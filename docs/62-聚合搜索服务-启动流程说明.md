# èšåˆæœç´¢æœåŠ¡ - å¯åŠ¨æµç¨‹è¯´æ˜

## ğŸ“‹ æœåŠ¡æ¦‚è§ˆ

**æœåŠ¡åç§°**: intelli-search-service  
**æœåŠ¡ç«¯å£**: 8086  
**ä¸»ç±»**: `com.intellihub.IntelliSearchServiceApplication`

---

## ğŸš€ å¯åŠ¨æµç¨‹

### 1. å¯åŠ¨å…¥å£

**ä¸»ç±»**: `IntelliSearchServiceApplication.java`

```java
@SpringBootApplication(scanBasePackages = {"com.intellihub"})
@EnableDiscoveryClient
@EnableTransactionManagement
@EnableScheduling
@EnableDubbo
public class IntelliSearchServiceApplication {
    public static void main(String[] args) {
        SpringApplication.run(IntelliSearchServiceApplication.class, args);
    }
}
```

**å¯åŠ¨æ³¨è§£è¯´æ˜**:
- `@SpringBootApplication(scanBasePackages = {"com.intellihub"})` - æ‰«ææ‰€æœ‰com.intellihubåŒ…
- `@EnableDiscoveryClient` - å¯ç”¨NacosæœåŠ¡å‘ç°
- `@EnableTransactionManagement` - å¯ç”¨äº‹åŠ¡ç®¡ç†
- `@EnableScheduling` - å¯ç”¨å®šæ—¶ä»»åŠ¡
- `@EnableDubbo` - å¯ç”¨Dubbo RPC

---

### 2. é…ç½®åŠ è½½

**é…ç½®æ–‡ä»¶**: `application.yml`

#### 2.1 åŸºç¡€é…ç½®
```yaml
server:
  port: 8086

spring:
  application:
    name: intelli-search-service
  profiles:
    active: dev
```

#### 2.2 Nacosé…ç½®
```yaml
spring:
  cloud:
    nacos:
      discovery:
        server-addr: 127.0.0.1:8848
        namespace: dev
        group: DEFAULT_GROUP
```

#### 2.3 æ•°æ®æºé…ç½®
```yaml
spring:
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://192.168.200.130:3306/intelli_hub_search
    username: root
    password: root
```

#### 2.4 Redisé…ç½®
```yaml
spring:
  redis:
    host: 192.168.200.130
    port: 6379
    database: 2
    password: root
```

#### 2.5 Elasticsearché…ç½®
```yaml
intellihub:
  elasticsearch:
    enabled: true
    hosts:
      - 192.168.200.130:9200
    username:
    password:
    connect-timeout: 5s
    socket-timeout: 30s
```

---

### 3. ç´¢å¼•åˆå§‹åŒ– (@PostConstruct)

æœåŠ¡å¯åŠ¨å,ä¼šè‡ªåŠ¨åˆå§‹åŒ–Elasticsearchç´¢å¼•ã€‚

#### 3.1 APIç´¢å¼•åˆå§‹åŒ–

**ç±»**: `ApiIndexService.java`

```java
@PostConstruct
public void initIndex() {
    try {
        if (!elasticsearchTemplate.indexExists(IndexConstants.INDEX_API)) {
            Map<String, Object> mappings = buildApiMappings();
            elasticsearchTemplate.createIndex(IndexConstants.INDEX_API, mappings);
            log.info("API ç´¢å¼•åˆ›å»ºæˆåŠŸ: {}", IndexConstants.INDEX_API);
        } else {
            log.info("API ç´¢å¼•å·²å­˜åœ¨: {}", IndexConstants.INDEX_API);
        }
    } catch (Exception e) {
        log.error("åˆå§‹åŒ– API ç´¢å¼•å¤±è´¥: {}", e.getMessage(), e);
        throw new RuntimeException("Elasticsearchåˆå§‹åŒ–å¤±è´¥,æœåŠ¡æ— æ³•å¯åŠ¨", e);
    }
}
```

**ç´¢å¼•åç§°**: `intellihub_api`  
**å­—æ®µæ•°**: 24ä¸ª  
**åŒ…å«**: æ‰€æœ‰APIå®ä½“å­—æ®µ + ç»Ÿè®¡å­—æ®µ

---

#### 3.2 åº”ç”¨ç´¢å¼•åˆå§‹åŒ–

**ç±»**: `AppIndexService.java`

```java
@PostConstruct
public void initIndex() {
    try {
        if (!elasticsearchTemplate.indexExists(IndexConstants.INDEX_APP)) {
            Map<String, Object> mappings = buildAppMappings();
            elasticsearchTemplate.createIndex(IndexConstants.INDEX_APP, mappings);
            log.info("åº”ç”¨ç´¢å¼•åˆ›å»ºæˆåŠŸ: {}", IndexConstants.INDEX_APP);
        } else {
            log.info("åº”ç”¨ç´¢å¼•å·²å­˜åœ¨: {}", IndexConstants.INDEX_APP);
        }
    } catch (Exception e) {
        log.error("åˆå§‹åŒ–åº”ç”¨ç´¢å¼•å¤±è´¥: {}", e.getMessage(), e);
        throw new RuntimeException("Elasticsearchåˆå§‹åŒ–å¤±è´¥,æœåŠ¡æ— æ³•å¯åŠ¨", e);
    }
}
```

**ç´¢å¼•åç§°**: `intellihub_app`  
**å­—æ®µæ•°**: 19ä¸ª  
**åŒ…å«**: æ‰€æœ‰åº”ç”¨å®ä½“å­—æ®µ + ç»Ÿè®¡å­—æ®µ

---

#### 3.3 ç”¨æˆ·ç´¢å¼•åˆå§‹åŒ–

**ç±»**: `UserIndexService.java`

```java
@PostConstruct
public void initIndex() {
    try {
        if (!elasticsearchTemplate.indexExists(IndexConstants.INDEX_USER)) {
            Map<String, Object> mappings = buildUserMappings();
            elasticsearchTemplate.createIndex(IndexConstants.INDEX_USER, mappings);
            log.info("ç”¨æˆ·ç´¢å¼•åˆ›å»ºæˆåŠŸ: {}", IndexConstants.INDEX_USER);
        } else {
            log.info("ç”¨æˆ·ç´¢å¼•å·²å­˜åœ¨: {}", IndexConstants.INDEX_USER);
        }
    } catch (Exception e) {
        log.error("åˆå§‹åŒ–ç”¨æˆ·ç´¢å¼•å¤±è´¥: {}", e.getMessage(), e);
        throw new RuntimeException("Elasticsearchåˆå§‹åŒ–å¤±è´¥,æœåŠ¡æ— æ³•å¯åŠ¨", e);
    }
}
```

**ç´¢å¼•åç§°**: `intellihub_user`  
**å­—æ®µæ•°**: 15ä¸ª  
**åŒ…å«**: æ‰€æœ‰ç”¨æˆ·å®ä½“å­—æ®µ + æ‰©å±•å­—æ®µ

---

### 4. å¥åº·æ£€æŸ¥åˆå§‹åŒ–

**ç±»**: `ElasticsearchHealthIndicator.java`

```java
@Component
public class ElasticsearchHealthIndicator implements HealthIndicator {
    @Override
    public Health health() {
        try {
            boolean isAvailable = checkElasticsearchConnection();
            if (isAvailable) {
                return Health.up()
                        .withDetail("status", "Elasticsearch is available")
                        .build();
            } else {
                return Health.down()
                        .withDetail("status", "Elasticsearch is not available")
                        .build();
            }
        } catch (Exception e) {
            return Health.down()
                    .withDetail("error", e.getMessage())
                    .build();
        }
    }
}
```

**å¥åº·æ£€æŸ¥ç«¯ç‚¹**: `http://localhost:8086/actuator/health`

---

### 5. å®šæ—¶ä»»åŠ¡åˆå§‹åŒ–

**é…ç½®**: `application.yml`

```yaml
intellihub:
  search:
    sync:
      full-cron: "0 0 2 * * ?"              # æ¯å¤©å‡Œæ™¨2ç‚¹å…¨é‡åŒæ­¥
      incremental-cron: "0 */5 * * * ?"     # æ¯5åˆ†é’Ÿå¢é‡åŒæ­¥
      app-full-cron: "0 0 2 * * ?"
      app-incremental-cron: "0 */5 * * * ?"
      user-full-cron: "0 0 2 * * ?"
      user-incremental-cron: "0 */5 * * * ?"
```

**è¯´æ˜**: å®šæ—¶ä»»åŠ¡ä¼šåœ¨æœåŠ¡å¯åŠ¨åæŒ‰é…ç½®çš„cronè¡¨è¾¾å¼æ‰§è¡Œ

---

## ğŸ“Š å¯åŠ¨æµç¨‹å›¾

```
1. å¯åŠ¨å…¥å£
   â†“
2. åŠ è½½é…ç½®æ–‡ä»¶ (application.yml)
   â†“
3. åˆå§‹åŒ–Springå®¹å™¨
   â”œâ”€ æ‰«æcom.intellihubåŒ…
   â”œâ”€ æ³¨å†ŒBean
   â””â”€ ä¾èµ–æ³¨å…¥
   â†“
4. è¿æ¥å¤–éƒ¨æœåŠ¡
   â”œâ”€ Nacos (æœåŠ¡æ³¨å†Œ)
   â”œâ”€ MySQL (æ•°æ®åº“)
   â”œâ”€ Redis (ç¼“å­˜)
   â””â”€ Elasticsearch (æœç´¢å¼•æ“)
   â†“
5. ç´¢å¼•åˆå§‹åŒ– (@PostConstruct)
   â”œâ”€ ApiIndexService.initIndex()
   â”œâ”€ AppIndexService.initIndex()
   â””â”€ UserIndexService.initIndex()
   â†“
6. å¥åº·æ£€æŸ¥åˆå§‹åŒ–
   â””â”€ ElasticsearchHealthIndicator
   â†“
7. å®šæ—¶ä»»åŠ¡åˆå§‹åŒ–
   â””â”€ é…ç½®å®šæ—¶åŒæ­¥ä»»åŠ¡
   â†“
8. å¯åŠ¨WebæœåŠ¡å™¨
   â””â”€ ç›‘å¬ç«¯å£ 8086
   â†“
9. æœåŠ¡å°±ç»ª
   â””â”€ å¯ä»¥æ¥æ”¶è¯·æ±‚
```

---

## âš ï¸ å¯åŠ¨ä¾èµ–æ£€æŸ¥

### å¿…é¡»å¯åŠ¨çš„æœåŠ¡

1. **Nacos** (127.0.0.1:8848)
   - ç”¨é€”: æœåŠ¡æ³¨å†Œä¸å‘ç°
   - æ£€æŸ¥: `curl http://127.0.0.1:8848/nacos`

2. **MySQL** (192.168.200.130:3306)
   - ç”¨é€”: æ•°æ®æŒä¹…åŒ–
   - æ•°æ®åº“: `intelli_hub_search`
   - æ£€æŸ¥: `mysql -h 192.168.200.130 -u root -p`

3. **Redis** (192.168.200.130:6379)
   - ç”¨é€”: ç¼“å­˜
   - æ•°æ®åº“: 2
   - æ£€æŸ¥: `redis-cli -h 192.168.200.130 -p 6379 -a root`

4. **Elasticsearch** (192.168.200.130:9200)
   - ç”¨é€”: æœç´¢å¼•æ“
   - æ£€æŸ¥: `curl http://192.168.200.130:9200`

---

## ğŸš€ å¯åŠ¨å‘½ä»¤

### æ–¹å¼1: IDEå¯åŠ¨ (å¼€å‘ç¯å¢ƒ)

**IDEAå¯åŠ¨**:
1. æ‰“å¼€ `IntelliSearchServiceApplication.java`
2. ç‚¹å‡»ä¸»ç±»æ—è¾¹çš„ç»¿è‰²è¿è¡ŒæŒ‰é’®
3. æˆ–å³é”® â†’ Run 'IntelliSearchServiceApplication'

---

### æ–¹å¼2: Mavenå¯åŠ¨

```bash
cd d:\Develop\Code_github\intelli_hub\intellihub-parent\intelli-search-service

# æ–¹å¼1: ä½¿ç”¨Spring Bootæ’ä»¶
mvn spring-boot:run

# æ–¹å¼2: å…ˆæ‰“åŒ…å†è¿è¡Œ
mvn clean package -DskipTests
java -jar target/intelli-search-service-1.0.0-SNAPSHOT.jar
```

---

### æ–¹å¼3: æŒ‡å®šé…ç½®å¯åŠ¨

```bash
# æŒ‡å®šç¯å¢ƒ
java -jar target/intelli-search-service-1.0.0-SNAPSHOT.jar --spring.profiles.active=prod

# æŒ‡å®šç«¯å£
java -jar target/intelli-search-service-1.0.0-SNAPSHOT.jar --server.port=8087

# æŒ‡å®šå¤šä¸ªå‚æ•°
java -jar target/intelli-search-service-1.0.0-SNAPSHOT.jar \
  --spring.profiles.active=prod \
  --server.port=8087 \
  --intellihub.elasticsearch.hosts=localhost:9200
```

---

## ğŸ“‹ å¯åŠ¨æ—¥å¿—ç¤ºä¾‹

```
  .   ____          _            __ _ _
 /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \
( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \
 \\/  ___)| |_)| | | | | || (_| |  ) ) ) )
  '  |____| .__|_| |_|_| |_\__, | / / / /
 =========|_|==============|___/=/_/_/_/
 :: Spring Boot ::                (v2.7.0)

2025-01-04 10:00:00.123  INFO 12345 --- [main] c.i.IntelliSearchServiceApplication : Starting IntelliSearchServiceApplication
2025-01-04 10:00:01.234  INFO 12345 --- [main] c.i.IntelliSearchServiceApplication : No active profile set, falling back to default profiles: default
2025-01-04 10:00:02.345  INFO 12345 --- [main] o.s.cloud.context.scope.GenericScope     : BeanFactory id=...
2025-01-04 10:00:03.456  INFO 12345 --- [main] c.a.c.n.registry.NacosServiceRegistry    : nacos registry, DEFAULT_GROUP intelli-search-service 192.168.1.100:8086 register finished
2025-01-04 10:00:04.567  INFO 12345 --- [main] c.i.search.service.ApiIndexService       : API ç´¢å¼•å·²å­˜åœ¨: intellihub_api
2025-01-04 10:00:04.678  INFO 12345 --- [main] c.i.search.service.AppIndexService       : åº”ç”¨ç´¢å¼•å·²å­˜åœ¨: intellihub_app
2025-01-04 10:00:04.789  INFO 12345 --- [main] c.i.search.service.UserIndexService      : ç”¨æˆ·ç´¢å¼•å·²å­˜åœ¨: intellihub_user
2025-01-04 10:00:05.890  INFO 12345 --- [main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port(s): 8086 (http)
2025-01-04 10:00:05.901  INFO 12345 --- [main] c.a.c.n.registry.NacosServiceRegistry    : nacos registry, DEFAULT_GROUP intelli-search-service 192.168.1.100:8086 register finished
2025-01-04 10:00:06.012  INFO 12345 --- [main] c.i.IntelliSearchServiceApplication : Started IntelliSearchServiceApplication in 6.5 seconds
```

---

## âœ… å¯åŠ¨æˆåŠŸéªŒè¯

### 1. æ£€æŸ¥æœåŠ¡çŠ¶æ€
```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:8086/actuator/health

# é¢„æœŸå“åº”
{
  "status": "UP",
  "components": {
    "elasticsearch": {
      "status": "UP",
      "details": {
        "status": "Elasticsearch is available"
      }
    }
  }
}
```

### 2. æµ‹è¯•æœç´¢æ¥å£
```bash
# èšåˆæœç´¢
curl -X POST http://localhost:8086/api/v1/search/aggregate \
  -H "Content-Type: application/json" \
  -H "X-Tenant-Id: test-tenant" \
  -d '{
    "keyword": "test",
    "types": ["api", "app", "user"],
    "page": 1,
    "size": 10
  }'
```

### 3. æ£€æŸ¥Nacosæ³¨å†Œ
è®¿é—® Nacos æ§åˆ¶å°: `http://127.0.0.1:8848/nacos`  
æŸ¥çœ‹æœåŠ¡åˆ—è¡¨,ç¡®è®¤ `intelli-search-service` å·²æ³¨å†Œ

---

## âš ï¸ å¸¸è§å¯åŠ¨é—®é¢˜

### é—®é¢˜1: Elasticsearchè¿æ¥å¤±è´¥
**é”™è¯¯æ—¥å¿—**:
```
Elasticsearchåˆå§‹åŒ–å¤±è´¥,æœåŠ¡æ— æ³•å¯åŠ¨
```

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥Elasticsearchæ˜¯å¦å¯åŠ¨: `curl http://192.168.200.130:9200`
2. æ£€æŸ¥é…ç½®ä¸­çš„åœ°å€æ˜¯å¦æ­£ç¡®
3. æ£€æŸ¥ç½‘ç»œè¿æ¥

---

### é—®é¢˜2: Nacosè¿æ¥å¤±è´¥
**é”™è¯¯æ—¥å¿—**:
```
connect to nacos server fail
```

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥Nacosæ˜¯å¦å¯åŠ¨: `curl http://127.0.0.1:8848/nacos`
2. æ£€æŸ¥é…ç½®ä¸­çš„åœ°å€æ˜¯å¦æ­£ç¡®
3. æ£€æŸ¥namespaceå’Œgroupé…ç½®

---

### é—®é¢˜3: MySQLè¿æ¥å¤±è´¥
**é”™è¯¯æ—¥å¿—**:
```
Could not create connection to database server
```

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥MySQLæ˜¯å¦å¯åŠ¨
2. æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å­˜åœ¨: `intelli_hub_search`
3. æ£€æŸ¥ç”¨æˆ·åå¯†ç æ˜¯å¦æ­£ç¡®
4. æ£€æŸ¥ç½‘ç»œè¿æ¥

---

### é—®é¢˜4: Redisè¿æ¥å¤±è´¥
**é”™è¯¯æ—¥å¿—**:
```
Unable to connect to Redis
```

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥Redisæ˜¯å¦å¯åŠ¨
2. æ£€æŸ¥å¯†ç æ˜¯å¦æ­£ç¡®
3. æ£€æŸ¥databaseé…ç½®
4. æ£€æŸ¥ç½‘ç»œè¿æ¥

---

## ğŸ“ å¯åŠ¨æ£€æŸ¥æ¸…å•

- [ ] Nacoså·²å¯åŠ¨ (127.0.0.1:8848)
- [ ] MySQLå·²å¯åŠ¨ (192.168.200.130:3306)
- [ ] Rediså·²å¯åŠ¨ (192.168.200.130:6379)
- [ ] Elasticsearchå·²å¯åŠ¨ (192.168.200.130:9200)
- [ ] æ•°æ®åº“`intelli_hub_search`å·²åˆ›å»º
- [ ] é…ç½®æ–‡ä»¶`application.yml`å·²æ­£ç¡®é…ç½®
- [ ] ä¾èµ–å·²ä¸‹è½½ (`mvn dependency:resolve`)
- [ ] ç«¯å£8086æœªè¢«å ç”¨

---

## ğŸ¯ æ€»ç»“

**å¯åŠ¨æµç¨‹**:
1. âœ… åŠ è½½é…ç½®
2. âœ… åˆå§‹åŒ–Springå®¹å™¨
3. âœ… è¿æ¥å¤–éƒ¨æœåŠ¡
4. âœ… åˆå§‹åŒ–Elasticsearchç´¢å¼•
5. âœ… å¯åŠ¨WebæœåŠ¡å™¨
6. âœ… æœåŠ¡å°±ç»ª

**å…³é”®ç‚¹**:
- ç´¢å¼•åˆå§‹åŒ–åœ¨`@PostConstruct`é˜¶æ®µ
- å¦‚æœElasticsearchè¿æ¥å¤±è´¥,æœåŠ¡ä¼šæŠ›å‡ºå¼‚å¸¸å¹¶åœæ­¢å¯åŠ¨
- å¥åº·æ£€æŸ¥å¯ç”¨äºç›‘æ§æœåŠ¡çŠ¶æ€
- å®šæ—¶ä»»åŠ¡ä¼šåœ¨å¯åŠ¨åè‡ªåŠ¨æ‰§è¡Œ

---

*æ–‡æ¡£ç‰ˆæœ¬: v1.0*  
*æ›´æ–°æ—¶é—´: 2025-01-04*
