# 第二阶段开发说明 - 用户事件

## 概述

第二阶段实现了用户生命周期事件的发布功能，包括用户创建、更新、删除三个核心事件。通过事件中心，实现用户管理与其他服务的解耦。

**完成时间**: 2024-12-31  
**开发周期**: 1天

---

## 已完成的工作

### 1. 事件定义初始化 SQL 脚本

**文件**: `intelli-event-service/src/main/resources/db/init_events.sql`

**新增事件定义**:
- `user.created` - 用户创建事件
- `user.updated` - 用户更新事件
- `user.deleted` - 用户删除事件

**SQL 语句**:
```sql
-- 用户创建事件
INSERT INTO event_definition (id, tenant_id, event_code, event_name, event_type, description, status, created_at, updated_at)
VALUES (REPLACE(UUID(), '-', ''), 'system', 'user.created', '用户创建事件', 'USER', '用户创建时触发', 'ACTIVE', NOW(), NOW());

-- 用户更新事件
INSERT INTO event_definition (id, tenant_id, event_code, event_name, event_type, description, status, created_at, updated_at)
VALUES (REPLACE(UUID(), '-', ''), 'system', 'user.updated', '用户更新事件', 'USER', '用户更新时触发', 'ACTIVE', NOW(), NOW());

-- 用户删除事件
INSERT INTO event_definition (id, tenant_id, event_code, event_name, event_type, description, status, created_at, updated_at)
VALUES (REPLACE(UUID(), '-', ''), 'system', 'user.deleted', '用户删除事件', 'USER', '用户删除时触发', 'ACTIVE', NOW(), NOW());
```

### 2. 用户服务 Kafka 依赖

**文件**: `intelli-auth-iam-service/pom.xml`

**新增依赖**:
```xml
<!-- Kafka Starter -->
<dependency>
    <groupId>com.intellihub</groupId>
    <artifactId>kafka-spring-boot-starter</artifactId>
</dependency>
```

### 3. UserEventPublisher 事件发布器

**文件**: `intelli-auth-iam-service/src/main/java/com/intellihub/auth/service/UserEventPublisher.java`

**功能**:
- 发布用户创建事件 (`publishUserCreated`)
- 发布用户更新事件 (`publishUserUpdated`)
- 发布用户删除事件 (`publishUserDeleted`)

**代码特点**:
- 使用 Builder 模式构建事件数据
- 统一的事件发布方法
- 完整的日志记录
- 异常处理机制

**事件数据格式**:

**user.created**:
```json
{
  "tenantId": "租户ID",
  "eventCode": "user.created",
  "source": "auth-iam-service",
  "data": {
    "userId": "用户ID",
    "username": "用户名",
    "nickname": "昵称",
    "email": "邮箱",
    "phone": "手机号",
    "roleIds": ["角色ID1", "角色ID2"],
    "createdAt": "2024-12-31T10:30:00"
  },
  "timestamp": "2024-12-31T10:30:00"
}
```

**user.updated**:
```json
{
  "tenantId": "租户ID",
  "eventCode": "user.updated",
  "source": "auth-iam-service",
  "data": {
    "userId": "用户ID",
    "username": "用户名",
    "nickname": "昵称",
    "email": "邮箱",
    "phone": "手机号",
    "updatedAt": "2024-12-31T10:35:00"
  },
  "timestamp": "2024-12-31T10:35:00"
}
```

**user.deleted**:
```json
{
  "tenantId": "租户ID",
  "eventCode": "user.deleted",
  "source": "auth-iam-service",
  "data": {
    "userId": "用户ID",
    "username": "用户名",
    "deletedAt": "2024-12-31T10:40:00"
  },
  "timestamp": "2024-12-31T10:40:00"
}
```

### 4. UserServiceImpl 集成事件发布

**文件**: `intelli-auth-iam-service/src/main/java/com/intellihub/auth/service/impl/UserServiceImpl.java`

**修改点**:

#### 4.1 依赖注入
```java
private final UserEventPublisher userEventPublisher;
```

#### 4.2 createUser 方法
在用户创建成功后发布事件：
```java
// 发布用户创建事件到事件中心
userEventPublisher.publishUserCreated(
    user.getId(),
    user.getUsername(),
    user.getNickname(),
    user.getEmail(),
    user.getPhone(),
    request.getRoleIds(),
    tenantId
);
```

#### 4.3 updateUser 方法
在用户更新成功后发布事件：
```java
// 发布用户更新事件到事件中心
userEventPublisher.publishUserUpdated(
    user.getId(),
    user.getUsername(),
    user.getNickname(),
    user.getEmail(),
    user.getPhone(),
    user.getTenantId()
);
```

#### 4.4 deleteUser 方法
在用户删除成功后发布事件：
```java
// 发布用户删除事件到事件中心
userEventPublisher.publishUserDeleted(
    user.getId(),
    user.getUsername(),
    user.getTenantId()
);
```

---

## 事件流转架构

```
┌─────────────────┐
│   用户服务      │
│ (auth-iam)      │
└────────┬────────┘
         │ 1. 发布用户事件
         v
┌─────────────────────────────┐
│  Kafka Topic                │
│  intellihub-event           │
└──────┬──────────────────────┘
       │ 2. 消费事件
       v
┌─────────────────────────────┐
│  事件服务 EventConsumer     │
│  - 监听 Kafka Topic         │
│  - 查询订阅列表             │
│  - 分发给订阅者             │
│  - 记录消费日志             │
└──────┬──────────────────────┘
       │ 3. 分发事件
       v
┌─────────────────────────────┐
│  订阅者                     │
│  - 通知服务 (欢迎邮件)      │
│  - 审计服务 (操作日志)      │
│  - 统计服务 (用户统计)      │
└─────────────────────────────┘
```

---

## 订阅者规划

### 1. 通知服务 (Notification Service)

**订阅事件**: `user.created`, `user.updated`

**功能**:
- `user.created`: 发送欢迎邮件/短信
- `user.updated`: 发送信息变更通知

**实现方式**: Webhook

### 2. 审计服务 (Audit Service)

**订阅事件**: `user.created`, `user.updated`, `user.deleted`

**功能**:
- 记录所有用户操作日志
- 用于合规审计和安全追踪

**实现方式**: Webhook

### 3. 统计服务 (Statistics Service)

**订阅事件**: `user.created`, `user.deleted`

**功能**:
- 更新用户统计数据
- 用户增长趋势分析

**实现方式**: Webhook

---

## 技术要点

### 1. 事务一致性

事件发布在数据库事务提交之后执行，确保：
- 数据已成功保存到数据库
- 避免事件发布成功但数据回滚的情况

### 2. 异常处理

事件发布失败不影响主业务流程：
- 使用 try-catch 捕获异常
- 记录错误日志
- 不抛出异常到上层

### 3. 数据完整性

事件数据包含所有必要字段：
- 用户基本信息（userId, username, nickname, email, phone）
- 时间戳（createdAt, updatedAt, deletedAt）
- 租户信息（tenantId）

### 4. 日志记录

完整的日志记录：
- INFO 级别：事件发布成功
- DEBUG 级别：事件详细信息
- ERROR 级别：事件发布失败

---

## 与第一阶段的区别

| 对比项 | 第一阶段 (API + 告警) | 第二阶段 (用户) |
|--------|---------------------|----------------|
| 事件数量 | 6个 | 3个 |
| 服务模块 | API服务、治理服务 | 用户服务 |
| 事件类型 | API, ALERT | USER |
| 数据复杂度 | 中等 | 简单 |
| 订阅者 | 网关、审计、通知 | 通知、审计、统计 |

---

## 下一步工作

### 1. 实现订阅者 (优先级：高)

- [ ] 通知服务订阅用户事件
- [ ] 审计服务订阅用户事件
- [ ] 统计服务订阅用户事件

### 2. 第三阶段：应用事件 (优先级：中)

- [ ] app.created - 应用创建事件
- [ ] app.key.regenerated - 密钥重新生成事件

### 3. 前端界面开发 (优先级：低)

- [ ] 事件管理界面
- [ ] 订阅管理界面
- [ ] 监控追踪界面

---

## 常见问题

### Q1: 为什么用户更新事件不包含 roleIds？

**A**: 因为角色更新是可选的（`if (request.getRoleIds() != null)`），不是每次更新都会修改角色。如果需要角色信息，订阅者可以通过 userId 查询最新的角色列表。

### Q2: 用户删除是软删除还是硬删除？

**A**: 是软删除。代码中使用 `user.setDeletedAt(LocalDateTime.now())` 标记删除时间，数据仍保留在数据库中。

### Q3: 事件发布失败会影响用户操作吗？

**A**: 不会。事件发布使用 try-catch 捕获异常，失败只会记录错误日志，不会抛出异常影响主业务流程。

### Q4: 如何保证事件发布的顺序性？

**A**: Kafka 使用 tenantId 作为 key，相同租户的事件会发送到同一个分区，保证顺序性。

---

## 参考文档

- [事件中心实施计划](./30-事件中心-实施计划.md)
- [第一阶段开发说明](./31-事件中心-第一阶段开发说明.md)
- [第二阶段测试指南](./34-事件中心-第二阶段测试指南.md)
