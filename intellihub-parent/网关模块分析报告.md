# IntelliHub ç½‘å…³æ¨¡å—åˆ†ææŠ¥å‘Š

## ğŸ“‹ ç›®å½•
- [1. æ¦‚è¿°](#1-æ¦‚è¿°)
- [2. è¿‡æ»¤å™¨æ‰§è¡Œé¡ºåº](#2-è¿‡æ»¤å™¨æ‰§è¡Œé¡ºåº)
- [3. æ ¸å¿ƒæµç¨‹é€»è¾‘](#3-æ ¸å¿ƒæµç¨‹é€»è¾‘)
- [4. é—®é¢˜åˆ†æ](#4-é—®é¢˜åˆ†æ)
- [5. æ”¹è¿›å»ºè®®](#5-æ”¹è¿›å»ºè®®)

---

## 1. æ¦‚è¿°

IntelliHubç½‘å…³æœåŠ¡åŸºäºSpring Cloud Gatewayæ„å»ºï¼Œä½œä¸ºç³»ç»Ÿçš„ç»Ÿä¸€å…¥å£ï¼Œè´Ÿè´£è¯·æ±‚è·¯ç”±ã€è®¤è¯æˆæƒã€é™æµã€æ—¥å¿—è®°å½•ç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚

### 1.1 æŠ€æœ¯æ ˆ
- **Spring Cloud Gateway**: åŸºäºWebFluxçš„å“åº”å¼ç½‘å…³
- **Nacos**: æœåŠ¡å‘ç°ä¸é…ç½®ä¸­å¿ƒ
- **Redis**: ç¼“å­˜ã€é™æµã€Nonceé˜²é‡æ”¾
- **Dubbo**: RPCè°ƒç”¨ï¼ˆç§Ÿæˆ·éªŒè¯ã€AppKeyæœåŠ¡ï¼‰

### 1.2 ä¸»è¦åŠŸèƒ½æ¨¡å—
- JWTè®¤è¯ï¼ˆå†…éƒ¨ç”¨æˆ·ï¼‰
- AppKeyç­¾åè®¤è¯ï¼ˆå¼€æ”¾APIï¼‰
- å¤šç§Ÿæˆ·æ”¯æŒ
- é™æµä¿æŠ¤
- åŠ¨æ€è·¯ç”±ï¼ˆå¼€æ”¾APIï¼‰
- è®¿é—®æ—¥å¿—
- è¯·æ±‚Bodyç¼“å­˜

---

## 2. è¿‡æ»¤å™¨æ‰§è¡Œé¡ºåº

ç½‘å…³å…±æœ‰**8ä¸ªå…¨å±€è¿‡æ»¤å™¨**ï¼ŒæŒ‰ç…§Orderå€¼ä»å°åˆ°å¤§æ‰§è¡Œï¼š

```mermaid
graph TB
    Start[è¯·æ±‚åˆ°è¾¾ç½‘å…³] --> F1
    F1[1. CacheBodyFilter<br/>Order: -200<br/>ç¼“å­˜è¯·æ±‚Body] --> F2
    F2[2. OpenApiRouteMatchFilter<br/>Order: -100<br/>åŒ¹é…å¼€æ”¾APIè·¯ç”±] --> F3
    F3[3. GlobalTenantFilter<br/>Order: -90<br/>ç§Ÿæˆ·éªŒè¯] --> F4
    F4[4. AccessLogFilter<br/>Order: HIGHEST_PRECEDENCE+1<br/>è®¿é—®æ—¥å¿—è®°å½•] --> F5
    F5[5. JwtAuthenticationFilter<br/>Order: 1000<br/>JWTè®¤è¯] --> F6
    F6[6. AppKeyAuthenticationFilter<br/>Order: 1100<br/>AppKeyç­¾åè®¤è¯] --> F7
    F7[7. OpenApiRouteFilter<br/>Order: 1200<br/>åŠ¨æ€è·¯ç”±è½¬å‘] --> F8
    F8[8. RateLimitFilter<br/>Order: 2000<br/>é™æµæ§åˆ¶] --> Backend[è½¬å‘åˆ°åç«¯æœåŠ¡]
    
    style F1 fill:#e1f5ff
    style F2 fill:#e1f5ff
    style F3 fill:#fff3e0
    style F4 fill:#f3e5f5
    style F5 fill:#ffebee
    style F6 fill:#ffebee
    style F7 fill:#e8f5e9
    style F8 fill:#fff9c4
```

### 2.1 è¿‡æ»¤å™¨è¯¦ç»†è¯´æ˜

| é¡ºåº | è¿‡æ»¤å™¨åç§° | Orderå€¼ | ä¸»è¦åŠŸèƒ½ | å¤‡æ³¨ |
|------|-----------|---------|----------|------|
| 1 | CacheBodyFilter | -200 | ç¼“å­˜POST/PUT/PATCHè¯·æ±‚Body | è§£å†³Bodyåªèƒ½è¯»å–ä¸€æ¬¡çš„é—®é¢˜ |
| 2 | OpenApiRouteMatchFilter | -100 | åŒ¹é…å¼€æ”¾APIè·¯ç”±é…ç½® | ä¸ºåç»­è¿‡æ»¤å™¨æä¾›APIå…ƒæ•°æ® |
| 3 | GlobalTenantFilter | -90 | éªŒè¯ç§Ÿæˆ·æœ‰æ•ˆæ€§ï¼ˆDubboè°ƒç”¨+Redisç¼“å­˜ï¼‰ | ç™½åå•è·¯å¾„è·³è¿‡ |
| 4 | AccessLogFilter | HIGHEST_PRECEDENCE+1 | è®°å½•è¯·æ±‚å¼€å§‹å’Œç»“æŸæ—¥å¿— | è®°å½•è€—æ—¶ã€çŠ¶æ€ç  |
| 5 | JwtAuthenticationFilter | 1000 | JWT TokenéªŒè¯ï¼ˆå†…éƒ¨ç”¨æˆ·ï¼‰ | ç™½åå•è·¯å¾„è·³è¿‡ |
| 6 | AppKeyAuthenticationFilter | 1100 | AppKeyç­¾åè®¤è¯ï¼ˆå¼€æ”¾APIï¼‰ | é˜²é‡æ”¾ã€é˜²ç¯¡æ”¹ã€è®¢é˜…éªŒè¯ |
| 7 | OpenApiRouteFilter | 1200 | åŠ¨æ€è·¯ç”±è½¬å‘ï¼ˆHTTP/Dubbo/Mockï¼‰ | ä»…å¤„ç†å¼€æ”¾API |
| 8 | RateLimitFilter | 2000 | å¤šç»´åº¦é™æµï¼ˆIPã€Pathã€ç»„åˆï¼‰ | æ»‘åŠ¨çª—å£ç®—æ³• |

---

## 3. æ ¸å¿ƒæµç¨‹é€»è¾‘

### 3.1 å†…éƒ¨APIè¯·æ±‚æµç¨‹

```mermaid
sequenceDiagram
    participant Client as å®¢æˆ·ç«¯
    participant Gateway as ç½‘å…³
    participant Redis as Redis
    participant Auth as è®¤è¯æœåŠ¡
    participant Backend as åç«¯æœåŠ¡
    
    Client->>Gateway: 1. å‘é€è¯·æ±‚ï¼ˆå¸¦JWT Tokenï¼‰
    Gateway->>Gateway: 2. AccessLogFilterè®°å½•æ—¥å¿—
    Gateway->>Redis: 3. GlobalTenantFilteréªŒè¯ç§Ÿæˆ·
    Redis-->>Gateway: ç§Ÿæˆ·æœ‰æ•ˆ
    Gateway->>Gateway: 4. JwtAuthenticationFilteréªŒè¯JWT
    Gateway->>Gateway: 5. æå–ç”¨æˆ·ä¿¡æ¯åˆ°è¯·æ±‚å¤´
    Gateway->>Redis: 6. RateLimitFilteræ£€æŸ¥é™æµ
    Redis-->>Gateway: æœªè¶…é™
    Gateway->>Backend: 7. è½¬å‘è¯·æ±‚ï¼ˆå¸¦X-User-Idç­‰å¤´ï¼‰
    Backend-->>Gateway: 8. è¿”å›å“åº”
    Gateway-->>Client: 9. è¿”å›å“åº”
    Gateway->>Gateway: 10. AccessLogFilterè®°å½•å®Œæˆ
```

### 3.2 å¼€æ”¾APIè¯·æ±‚æµç¨‹

```mermaid
sequenceDiagram
    participant Client as å¤–éƒ¨è°ƒç”¨æ–¹
    participant Gateway as ç½‘å…³
    participant Redis as Redis
    participant ApiService as APIå¹³å°æœåŠ¡
    participant Backend as åç«¯æœåŠ¡/Dubbo
    
    Client->>Gateway: 1. å‘é€è¯·æ±‚ï¼ˆå¸¦ç­¾åå¤´ï¼‰
    Gateway->>Gateway: 2. CacheBodyFilterç¼“å­˜Body
    Gateway->>ApiService: 3. OpenApiRouteMatchFilteråŒ¹é…APIé…ç½®
    ApiService-->>Gateway: APIå…ƒæ•°æ®
    Gateway->>Redis: 4. AppKeyAuthenticationFilteréªŒè¯ç­¾å
    Note over Gateway,Redis: - æ—¶é—´æˆ³éªŒè¯<br/>- Nonceé˜²é‡æ”¾<br/>- HMAC-SHA256ç­¾å
    Gateway->>ApiService: 5. æ£€æŸ¥è®¢é˜…å…³ç³»
    ApiService-->>Gateway: å·²è®¢é˜…
    Gateway->>Gateway: 6. OpenApiRouteFilteræ ¹æ®é…ç½®è·¯ç”±
    alt HTTPåç«¯
        Gateway->>Backend: è½¬å‘åˆ°HTTPæœåŠ¡
        Backend-->>Gateway: è¿”å›å“åº”
    else Dubboåç«¯
        Gateway->>Backend: Dubboæ³›åŒ–è°ƒç”¨
        Backend-->>Gateway: è¿”å›ç»“æœ
    else Mockæ¨¡å¼
        Gateway->>Gateway: è¿”å›Mockæ•°æ®
    end
    Gateway-->>Client: 7. è¿”å›å“åº”
```

### 3.3 è®¤è¯æµç¨‹å¯¹æ¯”

| ç‰¹æ€§ | JWTè®¤è¯ï¼ˆå†…éƒ¨APIï¼‰ | AppKeyè®¤è¯ï¼ˆå¼€æ”¾APIï¼‰ |
|------|-------------------|---------------------|
| **é€‚ç”¨åœºæ™¯** | Web/ç§»åŠ¨ç«¯ç”¨æˆ·ç™»å½• | ç¬¬ä¸‰æ–¹åº”ç”¨è°ƒç”¨ |
| **è®¤è¯æ–¹å¼** | Bearer Token | ç­¾åï¼ˆAppKey + AppSecretï¼‰ |
| **è¯·æ±‚å¤´** | `Authorization: Bearer {token}` | `X-App-Key`, `X-Timestamp`, `X-Nonce`, `X-Signature` |
| **å®‰å…¨æªæ–½** | Tokenè¿‡æœŸã€åˆ·æ–° | é˜²é‡æ”¾ã€é˜²ç¯¡æ”¹ã€è®¢é˜…éªŒè¯ |
| **ç”¨æˆ·ä¿¡æ¯ä¼ é€’** | `X-User-Id`, `X-Username`, `X-User-Roles` | `X-App-Id`, `X-Tenant-Id` |
| **ç™½åå•** | ç™»å½•ã€æ³¨å†Œç­‰å…¬å¼€æ¥å£ | å¥åº·æ£€æŸ¥ã€æ–‡æ¡£ |

---

## 4. é—®é¢˜åˆ†æ

### ğŸ”´ ä¸¥é‡é—®é¢˜

#### 4.1 è¿‡æ»¤å™¨æ‰§è¡Œé¡ºåºæ··ä¹±

**é—®é¢˜æè¿°**ï¼š
- `AccessLogFilter`çš„Orderå€¼ä¸º`HIGHEST_PRECEDENCE + 1`ï¼ˆçº¦-2147483646ï¼‰ï¼Œä½†å®é™…åº”è¯¥åœ¨æœ€æ—©æ‰§è¡Œ
- `GlobalTenantFilter`ï¼ˆ-90ï¼‰åœ¨`AccessLogFilter`ä¹‹å‰æ‰§è¡Œï¼Œä¸ç¬¦åˆè®¾è®¡æ„å›¾
- æ—¥å¿—æ˜¾ç¤º"Order: HIGHEST_PRECEDENCE+1"ï¼Œä½†å®é™…å€¼æœªæ˜ç¡®

**å½±å“**ï¼š
- è®¿é—®æ—¥å¿—å¯èƒ½æ— æ³•è®°å½•æ‰€æœ‰è¯·æ±‚ï¼ˆè¢«å‰ç½®è¿‡æ»¤å™¨æ‹¦æˆªï¼‰
- è°ƒè¯•å›°éš¾ï¼Œæ‰§è¡Œé¡ºåºä¸ç›´è§‚

**å»ºè®®**ï¼š
```java
// AccessLogFilteråº”è¯¥ä½¿ç”¨æ˜ç¡®çš„è´Ÿæ•°
@Override
public int getOrder() {
    return -300;  // ç¡®ä¿åœ¨æ‰€æœ‰ä¸šåŠ¡è¿‡æ»¤å™¨ä¹‹å‰
}
```

#### 4.2 ç§Ÿæˆ·éªŒè¯é€»è¾‘å­˜åœ¨é™çº§é£é™©

**é—®é¢˜ä»£ç **ï¼ˆGlobalTenantFilter.java:109-111ï¼‰ï¼š
```java
} catch (Exception e) {
    log.error("DubboéªŒè¯ç§Ÿæˆ·å¤±è´¥ - tenantId: {}", tenantId, e);
    // å‡ºé”™æ—¶é»˜è®¤å…è®¸ï¼ˆé™çº§ç­–ç•¥ï¼‰
    return true;
}
```

**é£é™©**ï¼š
- DubboæœåŠ¡ä¸å¯ç”¨æ—¶ï¼Œæ‰€æœ‰ç§Ÿæˆ·éªŒè¯éƒ½ä¼šé€šè¿‡
- å¯èƒ½å¯¼è‡´æœªæˆæƒçš„ç§Ÿæˆ·è®¿é—®ç³»ç»Ÿ

**å»ºè®®**ï¼š
- æ”¹ä¸ºå¤±è´¥æ‹’ç»ç­–ç•¥ï¼Œæˆ–è€…æä¾›å¯é…ç½®çš„é™çº§å¼€å…³
- å¢åŠ ç†”æ–­æœºåˆ¶ï¼Œé¿å…å¤§é‡Dubboè°ƒç”¨å¤±è´¥

#### 4.3 AppKeyè®¤è¯ä¸JWTè®¤è¯é‡å¤æ‰§è¡Œ

**é—®é¢˜æè¿°**ï¼š
- JWTè®¤è¯ï¼ˆOrder: 1000ï¼‰å’ŒAppKeyè®¤è¯ï¼ˆOrder: 1100ï¼‰éƒ½æ˜¯å…¨å±€è¿‡æ»¤å™¨
- å¯¹äºå¼€æ”¾APIè¯·æ±‚ï¼ŒJWTè®¤è¯ä¼šå…ˆæ‰§è¡Œï¼ˆæ£€æŸ¥ç™½åå•æ‰è·³è¿‡ï¼‰
- å­˜åœ¨ä¸å¿…è¦çš„æ€§èƒ½å¼€é”€

**å½“å‰æµç¨‹**ï¼š
```
å¼€æ”¾APIè¯·æ±‚ (/open/xxx)
  -> JwtAuthenticationFilteræ£€æŸ¥ç™½åå• âœ…è·³è¿‡
  -> AppKeyAuthenticationFilteræ‰§è¡Œè®¤è¯ âœ…é€šè¿‡
```

**å»ºè®®**ï¼š
- å°†AppKeyè®¤è¯æ”¹ä¸ºè·¯ç”±çº§åˆ«è¿‡æ»¤å™¨ï¼Œåªåœ¨å¼€æ”¾APIè·¯ç”±ä¸Šç”Ÿæ•ˆ
- æˆ–è€…ä¼˜åŒ–Orderé¡ºåºï¼Œè®©AppKeyè®¤è¯å…ˆæ‰§è¡Œ

#### 4.4 é™æµè¿‡æ»¤å™¨è¿‡åº¦å¤æ‚

**é—®é¢˜ä»£ç **ï¼ˆRateLimitFilter.java:66-87ï¼‰ï¼š
```java
// å¹¶è¡Œæ£€æŸ¥ä¸åŒç»´åº¦çš„é™æµï¼ˆåµŒå¥—3å±‚ï¼‰
return rateLimitService.isAllowed(ipKey, limit.getRequests() * 2, limit.getWindow())
    .flatMap(ipAllowed -> {
        if (Boolean.FALSE.equals(ipAllowed)) {
            return handleRateLimit(exchange.getResponse(), "IPçº§åˆ«é™æµè§¦å‘");
        }
        return rateLimitService.isAllowed(pathKey, limit.getRequests() * 10, limit.getWindow());
    })
    .flatMap(pathAllowed -> {
        // å†æ£€æŸ¥ç»„åˆé™æµ...
    })
```

**é—®é¢˜**ï¼š
1. **ä¸²è¡Œæ‰§è¡Œ**ï¼šè™½ç„¶æ³¨é‡Šè¯´"å¹¶è¡Œæ£€æŸ¥"ï¼Œä½†å®é™…æ˜¯ä¸²è¡Œçš„flatMap
2. **ç¡¬ç¼–ç å€æ•°**ï¼š`* 2`ã€`* 10`ç­‰å€æ•°å…³ç³»ä¸å¯é…ç½®
3. **æ€§èƒ½é—®é¢˜**ï¼šæ¯ä¸ªè¯·æ±‚éœ€è¦3æ¬¡Redisè°ƒç”¨
4. **é€»è¾‘å¤æ‚**ï¼šIPé™æµ100*2=200æ¬¡ï¼ŒPathé™æµ100*10=1000æ¬¡ï¼Œå®é™…ç»„åˆé™æµ100æ¬¡ï¼Œå®¹æ˜“æ··æ·†

**å»ºè®®**ï¼š
- ä½¿ç”¨`Mono.zip()`å®ç°çœŸæ­£çš„å¹¶è¡Œæ£€æŸ¥
- å°†å€æ•°å…³ç³»é…ç½®åŒ–
- ç®€åŒ–é™æµç»´åº¦ï¼Œæˆ–è€…æ”¹ä¸ºå¯é€‰

### ğŸŸ¡ ä¸­ç­‰é—®é¢˜

#### 4.5 OpenApiRouteFilterä¸Spring Cloud Gatewayè·¯ç”±æœºåˆ¶å†²çª

**é—®é¢˜æè¿°**ï¼š
- `OpenApiRouteFilter`å°è¯•ä¿®æ”¹`GATEWAY_REQUEST_URL_ATTR`æ¥å®ç°åŠ¨æ€è·¯ç”±
- ä½†è¯·æ±‚å·²ç»è¢«Spring Cloud Gatewayçš„è·¯ç”±è§„åˆ™åŒ¹é…ï¼ˆapplication.ymlä¸­çš„routesé…ç½®ï¼‰
- å¯èƒ½å¯¼è‡´è·¯ç”±ä¸ç”Ÿæ•ˆæˆ–å†²çª

**å½“å‰é…ç½®**ï¼ˆapplication.yml:50-55ï¼‰ï¼š
```yaml
- id: open-api-service
  uri: lb://intelli-api-platform-service
  predicates:
    - Path=/api/open/**,/api/external/**
  filters:
    - StripPrefix=1
```

**å†²çªç‚¹**ï¼š
- Gatewayå·²ç»å°†`/api/open/**`è·¯ç”±åˆ°`intelli-api-platform-service`
- `OpenApiRouteFilter`åˆæƒ³åŠ¨æ€ä¿®æ”¹URIåˆ°å…¶ä»–æœåŠ¡
- ä¸¤è€…å¯èƒ½å†²çª

**å»ºè®®**ï¼š
- æ–¹æ¡ˆ1ï¼šç§»é™¤application.ymlä¸­çš„open-apiè·¯ç”±é…ç½®ï¼Œå®Œå…¨ç”±OpenApiRouteFilterå¤„ç†
- æ–¹æ¡ˆ2ï¼šä½¿ç”¨RouteLocatorç¼–ç¨‹å¼åŠ¨æ€è·¯ç”±ï¼Œè€Œä¸æ˜¯è¿‡æ»¤å™¨ä¿®æ”¹URI

#### 4.6 Bodyç¼“å­˜å¯èƒ½å¯¼è‡´å†…å­˜é—®é¢˜

**é—®é¢˜ä»£ç **ï¼ˆCacheBodyFilter.java:45-56ï¼‰ï¼š
```java
return DataBufferUtils.join(request.getBody())
    .flatMap(dataBuffer -> {
        byte[] bytes = new byte[dataBuffer.readableByteCount()];
        dataBuffer.read(bytes);
        String bodyString = new String(bytes, StandardCharsets.UTF_8);
        exchange.getAttributes().put(ATTR_CACHED_BODY, bodyString);
        // ...
    });
```

**é—®é¢˜**ï¼š
- å¤§æ–‡ä»¶ä¸Šä¼ ä¼šå°†æ•´ä¸ªBodyåŠ è½½åˆ°å†…å­˜
- æ²¡æœ‰å¤§å°é™åˆ¶æ£€æŸ¥
- å¯èƒ½å¯¼è‡´OOM

**å»ºè®®**ï¼š
- æ·»åŠ Bodyå¤§å°é™åˆ¶ï¼ˆå¦‚10MBï¼‰
- å¯¹äºè¶…å¤§è¯·æ±‚ï¼Œè·³è¿‡ç¼“å­˜æˆ–ä½¿ç”¨ç£ç›˜ç¼“å­˜
- æ·»åŠ ç›‘æ§å‘Šè­¦

#### 4.7 Dubboæ³›åŒ–è°ƒç”¨ç¼ºå°‘è¶…æ—¶å’Œé‡è¯•é…ç½®

**é—®é¢˜ä½ç½®**ï¼š`OpenApiRouteFilter.forwardToDubboBackend()`

**é—®é¢˜**ï¼š
- Dubboæ³›åŒ–è°ƒç”¨åªåœ¨å…¨å±€é…ç½®äº†5ç§’è¶…æ—¶
- æ²¡æœ‰é’ˆå¯¹ä¸åŒAPIçš„å·®å¼‚åŒ–è¶…æ—¶é…ç½®
- æ²¡æœ‰é‡è¯•ç­–ç•¥

**å»ºè®®**ï¼š
- åœ¨APIé…ç½®ä¸­å¢åŠ `dubboTimeout`å­—æ®µ
- æ”¯æŒé…ç½®é‡è¯•æ¬¡æ•°å’Œç­–ç•¥

### ğŸŸ¢ è½»å¾®é—®é¢˜

#### 4.8 æ—¥å¿—çº§åˆ«ä½¿ç”¨ä¸å½“

**é—®é¢˜**ï¼š
- ç”Ÿäº§ç¯å¢ƒå¯èƒ½äº§ç”Ÿå¤§é‡DEBUGæ—¥å¿—
- æŸäº›INFOæ—¥å¿—åº”è¯¥é™çº§ä¸ºDEBUG

**ç¤ºä¾‹**ï¼š
```java
log.info("ç”¨æˆ·è®¤è¯æˆåŠŸ - UserId: {}, Username: {}, Path: {}", ...);  // æ¯ä¸ªè¯·æ±‚éƒ½æ‰“å°
log.info("AppKeyè®¤è¯æˆåŠŸ - AppKey: {}, AppId: {}, ApiId: {}, Path: {}", ...);
```

**å»ºè®®**ï¼š
- è®¤è¯æˆåŠŸæ”¹ä¸ºDEBUGçº§åˆ«
- åªåœ¨è®¤è¯å¤±è´¥æ—¶ä½¿ç”¨WARN/ERROR

#### 4.9 ç¡¬ç¼–ç çš„é…ç½®å€¼

**ç¤ºä¾‹**ï¼š
- `DEFAULT_TENANT_ID = "default"`ï¼ˆGlobalTenantFilterï¼‰
- `NONCE_KEY_PREFIX = "appkey:nonce:"`ï¼ˆAppKeyAuthenticationFilterï¼‰
- `TENANT_CACHE_PREFIX = "gateway:tenant:valid:"`ï¼ˆGlobalTenantFilterï¼‰

**å»ºè®®**ï¼š
- ç§»åˆ°é…ç½®æ–‡ä»¶æˆ–é…ç½®ç±»ä¸­

#### 4.10 ç¼ºå°‘ç›‘æ§æŒ‡æ ‡

**é—®é¢˜**ï¼š
- æ²¡æœ‰æš´éœ²PrometheusæŒ‡æ ‡
- æ— æ³•ç›‘æ§é™æµè§¦å‘æ¬¡æ•°ã€è®¤è¯å¤±è´¥ç‡ç­‰å…³é”®æŒ‡æ ‡

**å»ºè®®**ï¼š
- é›†æˆMicrometer
- æ·»åŠ è‡ªå®šä¹‰æŒ‡æ ‡ï¼ˆé™æµã€è®¤è¯ã€è·¯ç”±è½¬å‘ç­‰ï¼‰

---

## 5. æ”¹è¿›å»ºè®®

### 5.1 çŸ­æœŸæ”¹è¿›ï¼ˆ1-2å‘¨ï¼‰

1. **ä¿®å¤è¿‡æ»¤å™¨æ‰§è¡Œé¡ºåº**
   - ç»Ÿä¸€ä½¿ç”¨æ˜ç¡®çš„è´Ÿæ•°Orderå€¼
   - ç¡®ä¿æ‰§è¡Œé¡ºåºç¬¦åˆé€»è¾‘

2. **ä¿®å¤ç§Ÿæˆ·éªŒè¯é™çº§ç­–ç•¥**
   - æ”¹ä¸ºå¤±è´¥æ‹’ç»æˆ–å¯é…ç½®é™çº§

3. **ç®€åŒ–é™æµé€»è¾‘**
   - æ”¹ä¸ºçœŸæ­£çš„å¹¶è¡Œæ£€æŸ¥
   - é…ç½®åŒ–å€æ•°å…³ç³»

4. **æ·»åŠ Bodyå¤§å°é™åˆ¶**
   - é˜²æ­¢OOMé£é™©

### 5.2 ä¸­æœŸæ”¹è¿›ï¼ˆ1ä¸ªæœˆï¼‰

1. **ä¼˜åŒ–è®¤è¯è¿‡æ»¤å™¨**
   - å°†AppKeyè®¤è¯æ”¹ä¸ºè·¯ç”±çº§åˆ«
   - å‡å°‘ä¸å¿…è¦çš„æ‰§è¡Œ

2. **é‡æ„åŠ¨æ€è·¯ç”±æœºåˆ¶**
   - ä½¿ç”¨RouteLocatoræ›¿ä»£è¿‡æ»¤å™¨ä¿®æ”¹URI
   - è§£å†³è·¯ç”±å†²çªé—®é¢˜

3. **å¢åŠ ç›‘æ§æŒ‡æ ‡**
   - é›†æˆPrometheus
   - æ·»åŠ Grafanaä»ªè¡¨æ¿

### 5.3 é•¿æœŸæ”¹è¿›ï¼ˆ2-3ä¸ªæœˆï¼‰

1. **å¼•å…¥ç†”æ–­é™çº§**
   - é›†æˆSentinelæˆ–Resilience4j
   - ä¿æŠ¤åç«¯æœåŠ¡

2. **APIç½‘å…³æ²»ç†å¹³å°**
   - å¯è§†åŒ–é…ç½®é™æµè§„åˆ™
   - å®æ—¶æŸ¥çœ‹è·¯ç”±çŠ¶æ€
   - åŠ¨æ€æ›´æ–°é…ç½®ï¼ˆæ— éœ€é‡å¯ï¼‰

3. **åˆ†å¸ƒå¼è¿½è¸ª**
   - é›†æˆSkyWalkingæˆ–Zipkin
   - å®Œæ•´çš„è¯·æ±‚é“¾è·¯è¿½è¸ª

---

## 6. æ€»ç»“

### 6.1 ä¼˜ç‚¹
âœ… åŠŸèƒ½å®Œå–„ï¼Œæ”¯æŒåŒè®¤è¯ä½“ç³»  
âœ… ä½¿ç”¨å“åº”å¼ç¼–ç¨‹ï¼Œæ€§èƒ½è¾ƒå¥½  
âœ… æ”¯æŒåŠ¨æ€è·¯ç”±å’ŒDubboæ³›åŒ–è°ƒç”¨  
âœ… æœ‰åŸºç¡€çš„é˜²æŠ¤æªæ–½ï¼ˆé™æµã€é˜²é‡æ”¾ï¼‰

### 6.2 ä¸è¶³
âŒ è¿‡æ»¤å™¨æ‰§è¡Œé¡ºåºæ··ä¹±  
âŒ ç§Ÿæˆ·éªŒè¯é™çº§ç­–ç•¥å­˜åœ¨å®‰å…¨éšæ‚£  
âŒ é™æµé€»è¾‘è¿‡åº¦å¤æ‚ä¸”éå¹¶è¡Œ  
âŒ åŠ¨æ€è·¯ç”±ä¸Gatewayè·¯ç”±æœºåˆ¶å†²çª  
âŒ ç¼ºå°‘ç›‘æ§å’Œé“¾è·¯è¿½è¸ª  
âŒ å†…å­˜å®‰å…¨é—®é¢˜ï¼ˆBodyç¼“å­˜æ— é™åˆ¶ï¼‰

### 6.3 æ ¸å¿ƒå»ºè®®
1. **ç«‹å³ä¿®å¤**ï¼šè¿‡æ»¤å™¨Orderã€ç§Ÿæˆ·éªŒè¯é™çº§ã€Bodyå¤§å°é™åˆ¶
2. **é‡ç‚¹ä¼˜åŒ–**ï¼šé™æµé€»è¾‘ã€åŠ¨æ€è·¯ç”±æœºåˆ¶ã€è®¤è¯è¿‡æ»¤å™¨èŒè´£
3. **é•¿æœŸè§„åˆ’**ï¼šç›‘æ§ä½“ç³»ã€ç†”æ–­é™çº§ã€æ²»ç†å¹³å°

---

## é™„å½•

### A. è¿‡æ»¤å™¨Orderå€¼å‚è€ƒè¡¨

| ç»„ä»¶ | å»ºè®®Orderå€¼ | è¯´æ˜ |
|------|------------|------|
| CacheBodyFilter | -300 | æœ€æ—©æ‰§è¡Œï¼Œç¼“å­˜Body |
| OpenApiRouteMatchFilter | -200 | è·¯ç”±åŒ¹é… |
| AccessLogFilter | -100 | æ—¥å¿—è®°å½•å¼€å§‹ |
| GlobalTenantFilter | 100 | ç§Ÿæˆ·éªŒè¯ |
| JwtAuthenticationFilter | 200 | JWTè®¤è¯ |
| AppKeyAuthenticationFilter | 300 | AppKeyè®¤è¯ |
| OpenApiRouteFilter | 400 | åŠ¨æ€è·¯ç”± |
| RateLimitFilter | 500 | é™æµ |

### B. å…³é”®é…ç½®é¡¹

```yaml
# å»ºè®®çš„é…ç½®ç»“æ„
intellihub:
  gateway:
    # é€šç”¨é…ç½®
    default-tenant-id: default
    body-size-limit: 10485760  # 10MB
    
    # è®¤è¯é…ç½®
    auth:
      enabled: true
      secret: ${JWT_SECRET}
      token-expiration: 24
      
    # ç§Ÿæˆ·é…ç½®
    tenant:
      cache-ttl: 300  # 5åˆ†é’Ÿ
      fallback-allow: false  # Dubboå¤±è´¥æ—¶æ‹’ç»è¯·æ±‚
      
    # é™æµé…ç½®
    rate-limit:
      enabled: true
      parallel-check: true  # å¹¶è¡Œæ£€æŸ¥å¤šä¸ªç»´åº¦
      dimensions:
        - name: ip
          multiplier: 2
        - name: path
          multiplier: 10
        - name: combined
          multiplier: 1
```

---

**æ–‡æ¡£ç”Ÿæˆæ—¶é—´**: 2024-12-23  
**åˆ†æäººå‘˜**: AI Assistant  
**ç‰ˆæœ¬**: v1.0
