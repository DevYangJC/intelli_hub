server:
  port: 8080

spring:
  application:
    name: intelli-gateway-service

  # Spring Cloud 2020+需要显式导入Nacos配置
  config:
    import:
      - optional:nacos:intelli-gateway-service.yml

  cloud:
    nacos:
      discovery:
        server-addr: 127.0.0.1:8848
        namespace: 1744c84b-1d42-4adb-a68f-4beaa6d64a9a
        group: DEFAULT_GROUP
      config:
        server-addr: 127.0.0.1:8848
        file-extension: yml
        namespace: 1744c84b-1d42-4adb-a68f-4beaa6d64a9a
        group: DEFAULT_GROUP

    gateway:
      discovery:
        locator:
          enabled: true
          lower-case-service-id: true

      # 路由规则
      routes:
        # 认证服务路由
        - id: auth-service
          uri: lb://intelli-auth-iam-service
          predicates:
            - Path=/api/auth/**,/api/iam/**
          filters:
            - StripPrefix=1

        # API平台服务路由（管理接口 + 旧版开放API）
        - id: api-platform-service
          uri: lb://intelli-api-platform-service
          predicates:
            - Path=/api/v1/apis/**,/api/v1/api-groups/**,/api/v1/public/apis/**,/api/platform/**,/api/v1/gateway/**,/api/open/**,/api/external/**
          filters:
            - StripPrefix=1

        # 开放API路由（动态路由，由OpenApiRouteFilter处理）
        - id: open-api-dynamic
          uri: forward:/open
          predicates:
            - Path=/open/**,/external/**
          order: 0

        # 治理服务路由
        - id: governance-service
          uri: lb://intelli-governance-service
          predicates:
            - Path=/api/governance/**,/api/monitor/**
          filters:
            - StripPrefix=1

        # AIGC服务路由
        - id: aigc-service
          uri: lb://intelli-aigc-service
          predicates:
            - Path=/api/aigc/**,/api/ai/**
          filters:
            - StripPrefix=1

        # 应用中心服务路由
        - id: app-center-service
          uri: lb://intelli-app-center-service
          predicates:
            - Path=/api/app-center/**
          filters:
            - StripPrefix=2

        # 搜索服务路由
        - id: search-service
          uri: lb://intelli-search-service
          predicates:
            - Path=/api/v1/search/**,/api/search/**
          filters:
            - StripPrefix=1

        # 事件服务路由
        - id: event-service
          uri: lb://intelli-event-service
          predicates:
            - Path=/api/event/**
          filters:
            - StripPrefix=1

  # Redis配置
  redis:
    host: 192.168.200.130
    port: 6379
    database: 0
    timeout: 3000ms
    password: root
    lettuce:
      pool:
        max-active: 8
        max-wait: -1ms
        max-idle: 8
        min-idle: 0

  # Kafka配置
  kafka:
    bootstrap-servers: 192.168.200.130:9092
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.apache.kafka.common.serialization.StringSerializer
      acks: 1
      retries: 3

# Feign 配置
feign:
  client:
    config:
      default:
        connectTimeout: 5000
        readTimeout: 5000
        loggerLevel: basic
      intelli-auth-iam-service:
        connectTimeout: 3000
        readTimeout: 3000
        loggerLevel: full

# 管理端点配置
management:
  endpoints:
    web:
      exposure:
        include: health,info,gateway,metrics,prometheus
  endpoint:
    health:
      show-details: always
    gateway:
      enabled: true

# 网关自定义配置
intellihub:
  gateway:
    # 白名单配置
    whitelist:
      paths:
        - /actuator/**
        - /health/**
        - /api/auth/**
        - /api/iam/v1/auth/**
        - /iam/v1/auth/**
        - /swagger-ui/**
        - /v3/api-docs/**
        - /
        - /api/public/**
        - /api/v1/search/**
        - /api/search/**
        - /open/**
        - /external/**
        - /api/open/**
        - /api/external/**
    
    auth:
      enabled: true
      secret: intellihub-iam-jwt-secret-key-2024
      token-expiration: 24  # Token有效期（小时）

    rate-limit:
      enabled: true
      key-prefix: "rate_limit:"
      # 限流算法：SLIDING_WINDOW（滑动窗口，推荐）、FIXED_WINDOW（固定窗口）、TOKEN_BUCKET（令牌桶）
      algorithm: SLIDING_WINDOW
      error-message: "请求过于频繁，请稍后再试"

      # 默认限流配置（每分钟100次请求）
      # 说明：限流维度为 IP+Path 组合，即同一IP访问同一路径的限制
      default-limit:
        requests: 100
        window: 60

      # 特定路径限流配置
      limits:
        # 登录接口更严格（每分钟5次，防止暴力破解）
        "/api/auth/**":
          requests: 5
          window: 60
        # 搜索接口更宽松（每分钟200次）
        "/api/search/**":
          requests: 200
          window: 60
        # 上传接口最严格（每分钟10次，防止资源滥用）
        "/api/**/upload":
          requests: 10
          window: 60

# AppKey认证配置（开放API使用）
gateway:
  appkey:
    enabled: true  # 启用AppKey认证
    timestamp-tolerance: 300  # 时间戳容差（秒）
    nonce-expire-seconds: 600  # Nonce过期时间（秒）
    # 需要AppKey认证的路径
    auth-paths:
      - /open/**
      - /external/**
    # 跳过认证的路径
    skip-paths:
      - /open/health
      - /open/docs/**

# Dubbo 配置
dubbo:
  application:
    name: intelli-gateway-service
    qos-enable: false
  registry:
    address: nacos://127.0.0.1:8848
    parameters:
      namespace: dev
  consumer:
    group: ${DUBBO_GROUP:intellihub}
    check: false
    timeout: 5000

# 日志配置
logging:
  level:
    org.springframework.cloud.gateway: DEBUG
    com.intellihub.gateway: DEBUG
