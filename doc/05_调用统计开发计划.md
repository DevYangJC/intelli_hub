# 调用统计采集开发计划

> 实现API调用统计功能，支持实时统计和历史查询

---

## 一、功能概述

### 1.1 核心能力

| 功能 | 说明 |
|------|------|
| **调用日志采集** | Gateway异步上报调用数据到Redis |
| **实时统计** | 基于Redis的实时调用计数 |
| **统计聚合** | 定时任务将实时数据聚合到MySQL |
| **多维查询** | 按API、应用、时间等维度查询统计 |
| **趋势分析** | 调用量、成功率、延迟趋势图 |

### 1.2 数据流向

```
Gateway请求 → AccessLogFilter → Redis(实时计数) → 定时任务 → MySQL(持久化)
                    ↓
              Redis Pub/Sub
                    ↓
           Governance服务(消费)
```

---

## 二、数据模型设计

### 2.1 调用日志表（api_call_log）

```sql
CREATE TABLE api_call_log (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键',
    tenant_id VARCHAR(32) NOT NULL COMMENT '租户ID',
    api_id VARCHAR(32) COMMENT 'API ID',
    api_path VARCHAR(255) NOT NULL COMMENT 'API路径',
    api_method VARCHAR(10) NOT NULL COMMENT '请求方法',
    app_id VARCHAR(32) COMMENT '应用ID',
    app_key VARCHAR(64) COMMENT 'AppKey',
    client_ip VARCHAR(50) COMMENT '客户端IP',
    status_code INT COMMENT '响应状态码',
    success TINYINT(1) DEFAULT 1 COMMENT '是否成功',
    latency INT COMMENT '响应时间(ms)',
    request_time DATETIME NOT NULL COMMENT '请求时间',
    error_message VARCHAR(500) COMMENT '错误信息',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    INDEX idx_tenant_api (tenant_id, api_id),
    INDEX idx_request_time (request_time),
    INDEX idx_app_id (app_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='API调用日志表';
```

### 2.2 调用统计表-小时维度（api_call_stats_hourly）

```sql
CREATE TABLE api_call_stats_hourly (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键',
    tenant_id VARCHAR(32) NOT NULL COMMENT '租户ID',
    api_id VARCHAR(32) COMMENT 'API ID',
    api_path VARCHAR(255) NOT NULL COMMENT 'API路径',
    app_id VARCHAR(32) COMMENT '应用ID',
    stat_time DATETIME NOT NULL COMMENT '统计时间(小时)',
    total_count BIGINT DEFAULT 0 COMMENT '总调用次数',
    success_count BIGINT DEFAULT 0 COMMENT '成功次数',
    fail_count BIGINT DEFAULT 0 COMMENT '失败次数',
    avg_latency INT DEFAULT 0 COMMENT '平均响应时间(ms)',
    max_latency INT DEFAULT 0 COMMENT '最大响应时间(ms)',
    min_latency INT DEFAULT 0 COMMENT '最小响应时间(ms)',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    UNIQUE KEY uk_stat (tenant_id, api_id, app_id, stat_time),
    INDEX idx_stat_time (stat_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='API调用统计表(小时)';
```

### 2.3 调用统计表-天维度（api_call_stats_daily）

```sql
CREATE TABLE api_call_stats_daily (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键',
    tenant_id VARCHAR(32) NOT NULL COMMENT '租户ID',
    api_id VARCHAR(32) COMMENT 'API ID',
    api_path VARCHAR(255) NOT NULL COMMENT 'API路径',
    app_id VARCHAR(32) COMMENT '应用ID',
    stat_date DATE NOT NULL COMMENT '统计日期',
    total_count BIGINT DEFAULT 0 COMMENT '总调用次数',
    success_count BIGINT DEFAULT 0 COMMENT '成功次数',
    fail_count BIGINT DEFAULT 0 COMMENT '失败次数',
    avg_latency INT DEFAULT 0 COMMENT '平均响应时间(ms)',
    max_latency INT DEFAULT 0 COMMENT '最大响应时间(ms)',
    min_latency INT DEFAULT 0 COMMENT '最小响应时间(ms)',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    UNIQUE KEY uk_stat (tenant_id, api_id, app_id, stat_date),
    INDEX idx_stat_date (stat_date)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='API调用统计表(天)';
```

---

## 三、Redis数据结构

### 3.1 实时计数器

```
# 当前小时调用总数
stats:hourly:{tenantId}:{apiId}:{hour} = count
TTL: 2小时

# 当前小时成功/失败数
stats:hourly:{tenantId}:{apiId}:{hour}:success = count
stats:hourly:{tenantId}:{apiId}:{hour}:fail = count

# 延迟统计（使用Sorted Set）
stats:latency:{tenantId}:{apiId}:{hour} = [latency1, latency2, ...]
```

### 3.2 调用日志队列

```
# 使用Redis List作为日志队列
call_log:queue = [log1, log2, log3, ...]
```

---

## 四、开发任务

### 4.1 Governance服务（后端）

| 任务 | 优先级 | 预估工时 | 状态 |
|------|--------|----------|------|
| 数据库表创建 | P0 | 0.5h | ✅ 已完成 |
| 实体类和Mapper | P0 | 1h | ✅ 已完成 |
| 调用日志消费者 | P0 | 2h | ✅ 已完成 (CallLogConsumer) |
| 实时统计Service | P0 | 2h | ✅ 已完成 (StatsService) |
| 统计聚合定时任务 | P0 | 2h | ❌ 待开发 |
| 统计查询接口 | P0 | 2h | ✅ 已完成 (StatsController) |
| 仪表盘数据接口 | P1 | 2h | ✅ 已完成 |

### 4.2 Gateway服务（日志采集）

| 任务 | 优先级 | 预估工时 | 状态 |
|------|--------|----------|------|
| 调用日志DTO | P0 | 0.5h | ✅ 已完成 (CallLogDTO) |
| AccessLogFilter改造 | P0 | 1h | ✅ 已完成 |
| Redis日志上报 | P0 | 1h | ✅ 已完成 (CallLogReportService) |

### 4.3 前端页面

| 任务 | 优先级 | 预估工时 | 状态 |
|------|--------|----------|------|
| 统计仪表盘页面 | P0 | 3h | ✅ 已完成 (StatsPage.vue) |
| API调用趋势图 | P0 | 2h | ✅ 已完成 (ECharts) |
| 调用日志列表 | P1 | 2h | ✅ 已完成 (CallLogsPage.vue) |

---

## 五、接口设计

### 5.1 统计查询接口

```
GET /governance/v1/stats/overview
- 获取整体统计概览（今日调用量、成功率、平均延迟）

GET /governance/v1/stats/trend
- 获取调用趋势（按小时/天）
- 参数：startTime, endTime, granularity(hour/day)

GET /governance/v1/stats/api/{apiId}
- 获取单个API的统计详情

GET /governance/v1/stats/app/{appId}
- 获取单个应用的统计详情

GET /governance/v1/stats/top
- 获取Top N API（按调用量/错误率排序）
```

### 5.2 调用日志接口

```
GET /governance/v1/logs
- 分页查询调用日志
- 参数：apiId, appId, startTime, endTime, status, page, size
```

---

## 六、执行顺序

1. **创建数据库表** - SQL脚本
2. **Governance服务开发**
   - 实体类、Mapper
   - 调用日志消费Service
   - 统计查询Service
   - Controller接口
3. **Gateway改造**
   - 调用日志DTO
   - AccessLogFilter上报
4. **前端页面**
   - 统计仪表盘

---

---

## 七、已完成文件清单

### Gateway服务
- `AccessLogFilter.java` - 访问日志过滤器，记录调用日志
- `CallLogReportService.java` - 异步上报日志到Redis队列

### Governance服务
- `governance_tables.sql` - 数据库表结构
- `ApiCallLog.java` - 调用日志实体
- `ApiCallStatsHourly.java` - 小时统计实体
- `ApiCallStatsDaily.java` - 天统计实体
- `CallLogDTO.java` - 调用日志DTO
- `CallLogService.java` - 调用日志服务
- `CallLogConsumer.java` - **Redis队列消费者**
- `StatsService.java` - 统计查询服务
- `CallLogController.java` - 日志查询接口
- `StatsController.java` - 统计查询接口

### 前端
- `StatsPage.vue` - 统计仪表盘
- `CallLogsPage.vue` - 调用日志列表
- `stats.ts` - 统计API接口

---

*文档版本：v1.1*
*更新时间：2024-12-24*
