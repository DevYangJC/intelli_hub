# IntelliHub 启动说明

## 一、环境准备

### 1.1 基础环境要求

| 组件 | 版本要求 | 说明 |
|-----|---------|------|
| JDK | 1.8+ | 后端运行环境 |
| Node.js | 20.x+ | 前端运行环境 |
| MySQL | 8.0+ | 数据库 |
| Redis | 6.0+ | 缓存和Token存储 |
| Nacos | 2.x | 服务注册与配置中心 |

### 1.2 服务端口规划

| 服务 | 端口 | 说明 |
|-----|------|------|
| 前端开发服务器 | 5173 | Vite开发服务器 |
| API网关 | 8080 | Spring Cloud Gateway |
| IAM认证服务 | 8081 | 身份认证与权限管理 |
| API平台服务 | 8082 | API管理（待开发） |
| 治理服务 | 8083 | 监控与治理（待开发） |
| Nacos | 8848 | 服务注册中心 |
| MySQL | 3306 | 数据库 |
| Redis | 6379 | 缓存 |

---

## 二、数据库初始化

### 2.1 创建数据库

执行以下SQL脚本初始化IAM数据库：

```bash
# 进入MySQL命令行
mysql -u root -p

# 执行初始化脚本
source intellihub-parent/intelli-auth-iam-service/src/main/resources/db/init.sql
```

### 2.2 初始化数据说明

脚本会创建以下初始数据：

**租户：**
- `platform` - 平台管理租户
- `demo` - 示例租户

**用户：**
- `admin` / `admin123` - 平台管理员
- `demo` / `admin123` - 演示用户

**角色：**
- `platform_admin` - 平台管理员
- `tenant_admin` - 租户管理员
- `api_developer` - API开发者
- `api_consumer` - API调用方
- `user` - 普通用户

---

## 三、后端服务启动

### 3.1 启动Nacos

```bash
# Windows
startup.cmd -m standalone

# Linux/Mac
sh startup.sh -m standalone
```

访问 http://localhost:8848/nacos 确认Nacos启动成功（默认账号：nacos/nacos）

### 3.2 启动Redis

```bash
redis-server
```

### 3.3 修改配置文件

根据实际环境修改以下配置文件：

**网关服务配置** (`intelli-gateway-service/src/main/resources/application.yml`)：
```yaml
spring:
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848  # Nacos地址
  redis:
    host: localhost  # Redis地址
    port: 6379
```

**IAM服务配置** (`intelli-auth-iam-service/src/main/resources/application.yml`)：
```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/intellihub_iam  # MySQL地址
    username: root
    password: root
  redis:
    host: localhost  # Redis地址
    port: 6379
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848  # Nacos地址
```

### 3.4 编译项目

```bash
cd intellihub-parent
mvn clean install -DskipTests
```

### 3.5 启动服务

**方式一：IDE启动**
1. 导入项目到IDEA
2. 先启动 `intelli-gateway-service`
3. 再启动 `intelli-auth-iam-service`

**方式二：命令行启动**
```bash
# 启动网关服务
cd intelli-gateway-service
mvn spring-boot:run

# 新开终端，启动IAM服务
cd intelli-auth-iam-service
mvn spring-boot:run
```

### 3.6 验证服务启动

```bash
# 检查网关健康状态
curl http://localhost:8080/actuator/health

# 检查IAM服务健康状态
curl http://localhost:8081/actuator/health
```

---

## 四、前端启动

### 4.1 安装依赖

```bash
cd intellihub-frontend
npm install
```

### 4.2 启动开发服务器

```bash
npm run dev
```

访问 http://localhost:5173 打开前端页面

### 4.3 API代理配置

前端开发服务器已配置代理，将 `/api` 请求转发到网关服务：

```typescript
// vite.config.ts
server: {
  port: 5173,
  proxy: {
    '/api': {
      target: 'http://localhost:8080',
      changeOrigin: true,
    },
  },
}
```

---

## 五、登录测试

### 5.1 测试账号

| 用户名 | 密码 | 角色 |
|-------|------|------|
| admin | admin123 | 平台管理员 |
| demo | admin123 | API开发者 |

### 5.2 登录流程

1. 打开前端页面 http://localhost:5173
2. 点击右上角"登录"按钮
3. 输入用户名和密码
4. 点击验证码图片获取验证码（如果后端未启动，可跳过）
5. 点击"登录"按钮

### 5.3 API调用流程

```
前端 -> Vite代理 -> 网关(8080) -> IAM服务(8081)
         |
         +-- /api/iam/v1/auth/login -> 登录接口
         +-- /api/iam/v1/auth/captcha -> 获取验证码
         +-- /api/iam/v1/auth/me -> 获取当前用户信息
```

---

## 六、常见问题

### 6.1 Nacos连接失败

**问题**：服务启动时报 Nacos 连接错误

**解决**：
1. 确认 Nacos 已启动
2. 检查配置文件中的 `server-addr` 是否正确
3. 检查防火墙是否放行 8848 端口

### 6.2 数据库连接失败

**问题**：IAM服务启动时报数据库连接错误

**解决**：
1. 确认 MySQL 已启动
2. 确认已执行数据库初始化脚本
3. 检查配置文件中的数据库连接信息

### 6.3 Redis连接失败

**问题**：登录时报 Redis 连接错误

**解决**：
1. 确认 Redis 已启动
2. 检查配置文件中的 Redis 连接信息

### 6.4 验证码获取失败

**问题**：点击验证码无法获取

**解决**：
1. 确认后端服务已启动
2. 检查浏览器控制台是否有网络错误
3. 可以暂时在IAM配置中关闭验证码：
   ```yaml
   intellihub:
     auth:
       captcha:
         enabled: false
   ```

---

## 七、下一步开发

完成登录流程后，可以继续开发以下功能：

1. **API平台服务** (`intelli-api-platform-service`)
   - API定义管理
   - API版本管理
   - API发布流程

2. **应用中心服务** (`intelli-app-center-service`)
   - 应用管理
   - AppKey/Secret管理
   - API订阅管理

3. **监控治理服务** (`intelli-governance-service`)
   - 调用统计
   - 流量监控
   - 告警管理
